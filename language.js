// 全局语言包对象
globalTranslations = {
  'zh-CN': {
    'appTitle': '收藏夹记事本',
    'themeSwitched': '已切换至%s主题',
    'downloadingTab': '下载',
    'downloadedTab': '已下载',
    'userManagement': '用户管理',
    'currentUser': '用户:',
    'switchUser': '切换用户',
    'customWindowTitle': '收藏地址',
    'copyAddress': '复制地址',
    'settingsTitle': '设置',
    'languageSettings': '语言设置',
    'interfaceLanguage': '界面语言',
    'languageSetTo': '语言已设置为%s',
    'languageSettingTitle': '语言设置',
    'interfaceLanguage': '界面语言',
    'simplifiedChinese': '简体中文',
    'english': 'English',
    'searchPlaceholder': '搜索收藏...',
    'addFavorite': '添加收藏',
    'edit': '编辑',
    'delete': '删除',
    'bookmarkList': '收藏列表',
    'enterURL': '请输入要收藏的URL：',
    'confirm': '确认',
    'cancel': '取消',
    'totalEpisodes': '总集数:',
    'downloadedEpisodes': '已下载集数:',
    'episodeTitle': '编辑集数',
    'addDialogTitle': '添加收藏',
    'editDialogTitle': '编辑收藏',
    'usernameDialogTitle': '设置用户名',
    'enterUsername': '请输入用户名:',
    'copy': '复制',
    'addressPlaceholder': '输入地址',
    'go': '前往',
    'aboutTitle': '关于',
    'favoritesTitle': 'Favorites',
    'settings': '设置',
    'language': '语言',
    'theme': '主题',
    'about': '关于',
    'exit': '退出',
    'add': '添加',
    'backToSettings': '返回设置',
    'backButton': '返回',
    'addBookmark': '添加收藏',
    'editBookmark': '编辑收藏',
    'deleteConfirm': '确认删除',
    'usernameCannotBeEmpty': '用户名不能为空',
    'noResultsFound': '未找到结果',
    'titleOptional': '标题（可选）:',
    'enterTitle': '请输入标题',
    'url': '收藏地址:',
    'enterUrl': '请输入收藏地址',
    'properties': '属性:',
    'internal': '内部',
    'external': '外部',
    'pinToTop': '置顶显示',
    'enterTotalEpisodes': '请输入总集数',
    'enterDownloadedEpisodes': '请输入已下载集数',
    'developerInfo': '开发者信息',
    'developer': '开发者: 胡岳超',
    'email': '邮箱: samson_hu@msn.com',
    'appIntroduction': '程序介绍',
    'appDescription': '收藏夹记事本是一款专为高效管理网络收藏内容打造的轻量级应用，致力于帮助用户系统化地组织、搜索和访问各类网址资源。',
    'mainFeatures': '主要功能:',
    'feature1': '支持网址收藏的添加、删除、编辑与批量管理，操作便捷直观',
    'feature2': '支持通过拖放操作自定义排序，收藏项目可按类别进行分组管理',
    'feature3': '支持多标签页浏览模式，可对收藏内容进行灵活分组及快速切换',
    'feature4': '内置智能搜索功能，支持关键词高亮显示，快速定位目标内容',
    'feature5': '提供简洁直观的用户界面，支持明亮/暗黑主题自定义切换',
    'feature6': '支持OneDrive云盘同步，实现多设备数据互通，随时备份与恢复',
    'feature7': '提供导入导出功能，支持与主流浏览器收藏夹格式兼容',
    'version': '版本: 1.0.1',
    'titleCannotBeEmpty': '标题不能为空',
    'urlCannotBeEmpty': '收藏地址不能为空',
    'invalidUrl': '请输入有效的URL地址',
    'nothingToCopy': '没有值可复制',
    'invalidLinkCannotCopy': '不是有效的链接，无法复制',
    'copyFailed': '复制失败，请手动复制',
    'operationFailed': '操作失败，请重试',
    'cancelOperationFailed': '取消操作失败:',
    'unknownError': '未知错误',
    'totalEpisodesOnlyNumbers': '总集数只能包含数字',
    'downloadedEpisodesOnlyNumbers': '已下载集数只能包含数字',
    'totalEpisodesValidNumber': '总集数必须是有效的数字',
    'totalEpisodesValidNonNegative': '总集数必须是有效的非负整数',
    'downloadedEpisodesValidNumber': '已下载集数必须是有效的数字',
    'downloadedEpisodesValidNonNegative': '已下载集数必须是有效的非负整数',
    'downloadedEpisodesCannotExceedTotal': '已下载集数不能大于总集数',
    'appAlreadyRunning': '程序已运行',
    'addUser': '添加用户',
    'appIsRunning': '应用程序已在运行中。',
    'errorReason': '错误原因',
    'openPrivacyPolicy': '打开隐私政策',
    'openFailed': '打开失败',
    'cannotOpenPrivacyPolicy': '无法打开隐私政策文件',
    'saveFavoritesFailed': '收藏保存失败',
    'addFailed': '添加失败',
    'saveFailed': '保存失败',
    'cannotFindFavoriteItem': '无法找到对应的收藏项，请刷新页面后重试',
    'interfaceSettings': '界面设置',
    'windowMode': '启动窗口模式:',
    'normalWindow': '普通窗口',
    'maximizedWindow': '最大化',
    'themeSelection': '主题选择',
    'dataManagement': '数据管理',
    'privacyPolicy': '隐私政策',
    'privacyPolicyDescription': '查看本应用如何保护您的隐私和处理您的数据。',
    'dataManagementDescription': '通过导入/导出功能，您可以备份收藏数据或与其他浏览器收藏夹进行同步。',
    'importFavoritesBtn': '导入收藏夹',
    'exportFavoritesBtn': '导出收藏夹',
    'defaultTheme': '默认主题',
    'darkTheme': '暗黑主题',
    'lightTheme': '明亮主题',
    'blueTheme': '蓝色主题',
    'greenTheme': '绿色主题',
    'purpleTheme': '紫色主题',
    'orangeTheme': '橙色主题',
    'loadFavoritesFailed': '加载收藏数据失败',
    'cannotLoadDialog': '无法加载对话框',
    'cannotFindFavoriteItemWithIndex': '无法找到对应的收藏项 (索引: %s)，请刷新页面后重试',
    'updateFailed': '更新失败',
    'cannotSaveFavorites': '无法保存收藏数据',
    'openExternalBrowserFailed': '无法打开外部浏览器',
    'selectFavoritesFile': '选择收藏夹文件',
    'jsonFiles': 'JSON Files',
    'allFiles': 'All Files',
    'importFavoritesSuccess': '收藏夹导入成功！',
    'importFailed': '导入失败',
    'exportFavorites': '导出收藏夹',
    'exportFavoritesSuccess': '收藏夹导出成功！',
    'exportFailed': '导出失败',
    'operationFailed': '操作失败',
    'defaultUser': 'Default',
    'userDataFileNotExistOrReadFailed': '用户数据文件不存在或读取失败',
    'useDefaultUser': '使用默认用户',
    'usernameLoading': '用户名：加载中...',
    'removeUser': '移除用户',
    'usernameExists': '该用户名已存在，请使用其他用户名',
    'keepAtLeastOneUser': '至少保留一个用户',
    'cannotRemoveDefaultUser': '不能移除默认用户',
    'confirmRemoveUser': '确定要删除用户"%s"及其实时数据吗？',
    'removeUserFailed': '移除用户失败，请重试',
    'supportAndDonation': '支持与捐赠',
    'donationDesc1': '收藏夹记事本是一款完全免费的开源软件，我们致力于为用户提供最好的收藏管理体验。',
    'donationDesc2': '如果您觉得这款软件对您有所帮助，并且经济条件允许，欢迎通过以下方式支持开发者，您的每一份支持都是我们继续开发和改进的动力！',
    'supportProject': '💖 支持项目发展 💖',
    'githubInfo': '您可以访问我们的 GitHub 项目主页，了解更多捐赠方式和项目信息：',
    'visitGithubProject': '访问 GitHub 项目',
    'donationMethodsInfo': '我们的所有捐赠方式都已整合到 GitHub 项目页面中。如果您想支持我们的开发工作，请通过上方按钮访问 GitHub 项目主页，在那里您可以找到包括支付宝在内的多种捐赠方式。',
    'thankYouSupport': '感谢您的支持，您的每一份鼓励都是我们前进的动力！',
    'aboutDeveloper': '关于开发者',
    'confirmDeleteFavorite': '确定要删除该收藏吗？',
    'favoriteDataNotLoaded': '收藏数据未加载',
    'cannotFindFavoriteItem': '找不到收藏项',
    'editEpisodesError': '编辑集数时出错',
    'dataEmptyAddFavorite': '数据为空，添加收藏地址',
    'noDownloadedItems': '暂无已下载项目',
    'noDownloadingItems': '暂无下载中项目',
    'visit': '访问',
    'setEpisodes': '设置集数',
    'action': '操作',
    'downloadedLabel': '下载: ',
    'downloadedLabelShort': '下载:',
    'fullyDownloaded': '已下载',
    'totalEpisodesShort': '总集数:',
    'downloadedEpisodesShort': '已下载:'
  },
  'en': {
    'appTitle': 'Favorites Browser',
    'themeSwitched': 'Switched to %s theme',
    'downloadingTab': 'Downloading',
    'downloadedTab': 'Downloaded',
    'userManagement': 'User Management',
    'currentUser': 'User:',
    'switchUser': 'Switch User',
    'customWindowTitle': 'Favorite Address',
    'copyAddress': 'Copy Address',
    'settingsTitle': 'Settings',
    'languageSettings': 'Language Settings',
    'interfaceLanguage': 'Interface Language',
    'languageSetTo': 'Language set to %s',
    'languageSettingTitle': 'Language Settings',
    'interfaceLanguage': 'Interface Language',
    'simplifiedChinese': 'Simplified Chinese',
    'english': 'English',
    'searchPlaceholder': 'Search favorites...',
    'addFavorite': 'Add Favorite',
    'edit': 'Edit',
    'delete': 'Delete',
    'bookmarkList': 'Bookmark List',
    'enterURL': 'Please enter URL to favorite:',
    'confirm': 'Confirm',
    'cancel': 'Cancel',
    'totalEpisodes': 'Total Episodes:',
    'downloadedEpisodes': 'Downloaded Episodes:',
    'episodeTitle': 'Edit Episodes',
    'addDialogTitle': 'Add Favorite',
    'editDialogTitle': 'Edit Favorite',
    'usernameDialogTitle': 'Set Username',
    'enterUsername': 'Please enter username:',
    'copy': 'Copy',
    'addressPlaceholder': 'Enter address',
    'go': 'Go',
    'aboutTitle': 'About',
    'favoritesTitle': 'Favorites',
    'settings': 'Settings',
    'language': 'Language',
    'theme': 'Theme',
    'about': 'About',
    'exit': 'Exit',
    'add': 'Add',
    'backToSettings': 'Back to Settings',
    'backButton': 'Back',
    'addBookmark': 'Add Bookmark',
    'editBookmark': 'Edit Bookmark',
    'deleteConfirm': 'Confirm Delete',
    'usernameCannotBeEmpty': 'Username cannot be empty',
    'noResultsFound': 'No results found',
    'titleOptional': 'Title (Optional):',
    'enterTitle': 'Please enter title',
    'url': 'Favorite URL:',
    'enterUrl': 'Please enter favorite URL',
    'properties': 'Properties:',
    'internal': 'Internal',
    'external': 'External',
    'pinToTop': 'Pin to top',
    'enterTotalEpisodes': 'Please enter total episodes',
    'enterDownloadedEpisodes': 'Please enter downloaded episodes',
    'developerInfo': 'Developer Information',
    'developer': 'Developer: Hu Yuechao',
    'email': 'Email: samson_hu@msn.com',
    'appIntroduction': 'App Introduction',
    'appDescription': 'Favorites Notes is a lightweight application designed for efficient management of online favorite content, dedicated to helping users systematically organize, search, and access various web resources.',
    'mainFeatures': 'Main Features:',
    'feature1': 'Supports adding, deleting, editing and batch management of URL favorites with intuitive operations',
    'feature2': 'Supports custom sorting via drag and drop, and favorites can be grouped by category',
    'feature3': 'Supports multi-tab browsing mode for flexible grouping and quick switching of favorite content',
    'feature4': 'Built-in intelligent search function with keyword highlighting for quick target content location',
    'feature5': 'Provides a clean and intuitive user interface with light/dark theme customization',
    'feature6': 'Supports OneDrive cloud sync for multi-device data interoperability, backup and recovery anytime',
    'feature7': 'Provides import/export functions compatible with mainstream browser bookmark formats',
    'version': 'Version: 1.0.1',
    'titleCannotBeEmpty': 'Title cannot be empty',
    'urlCannotBeEmpty': 'Favorite URL cannot be empty',
    'invalidUrl': 'Please enter a valid URL',
    'nothingToCopy': 'Nothing to copy',
    'invalidLinkCannotCopy': 'Not a valid link, cannot copy',
    'copyFailed': 'Copy failed, please copy manually',
    'operationFailed': 'Operation failed, please try again',
    'cancelOperationFailed': 'Cancel operation failed:',
    'unknownError': 'Unknown error',
    'totalEpisodesOnlyNumbers': 'Total episodes can only contain numbers',
    'downloadedEpisodesOnlyNumbers': 'Downloaded episodes can only contain numbers',
    'totalEpisodesValidNumber': 'Total episodes must be a valid number',
    'totalEpisodesValidNonNegative': 'Total episodes must be a valid non-negative integer',
    'downloadedEpisodesValidNumber': 'Downloaded episodes must be a valid number',
    'downloadedEpisodesValidNonNegative': 'Downloaded episodes must be a valid non-negative integer',
    'downloadedEpisodesCannotExceedTotal': 'Downloaded episodes cannot exceed total episodes',
    'appAlreadyRunning': 'App Already Running',
    'addUser': 'Add User',
    'appIsRunning': 'The application is already running.',
    'errorReason': 'Error reason',
    'openPrivacyPolicy': 'Open Privacy Policy',
    'openFailed': 'Open Failed',
    'cannotOpenPrivacyPolicy': 'Cannot open privacy policy file',
    'interfaceSettings': 'Interface Settings',
    'windowMode': 'Startup Window Mode:',
    'normalWindow': 'Normal Window',
    'maximizedWindow': 'Maximized',
    'themeSelection': 'Theme Selection',
    'dataManagement': 'Data Management',
    'privacyPolicy': 'Privacy Policy',
    'privacyPolicyDescription': 'View how this app protects your privacy and handles your data.',
    'dataManagementDescription': 'With import/export functions, you can back up your favorite data or synchronize with other browser favorites.',
    'importFavoritesBtn': 'Import Favorites',
    'exportFavoritesBtn': 'Export Favorites',
    'defaultTheme': 'Default Theme',
    'darkTheme': 'Dark Theme',
    'lightTheme': 'Light Theme',
    'blueTheme': 'Blue Theme',
    'greenTheme': 'Green Theme',
    'purpleTheme': 'Purple Theme',
    'orangeTheme': 'Orange Theme',
    'saveFavoritesFailed': 'Save Favorites Failed',
    'addFailed': 'Add Failed',
    'saveFailed': 'Save Failed',
    'cannotFindFavoriteItem': 'Cannot find the corresponding favorite item, please refresh the page and try again',
    'loadFavoritesFailed': 'Failed to load favorite data',
    'cannotLoadDialog': 'Cannot load dialog',
    'cannotFindFavoriteItemWithIndex': 'Cannot find the corresponding favorite item (index: %s), please refresh the page and try again',
    'updateFailed': 'Update Failed',
    'cannotSaveFavorites': 'Cannot save favorite data',
    'openExternalBrowserFailed': 'Cannot open external browser',
    'selectFavoritesFile': 'Select Favorites File',
    'jsonFiles': 'JSON Files',
    'allFiles': 'All Files',
    'importFavoritesSuccess': 'Favorites imported successfully!',
    'importFailed': 'Import Failed',
    'exportFavorites': 'Export Favorites',
    'exportFavoritesSuccess': 'Favorites exported successfully!',
    'exportFailed': 'Export Failed',
    'defaultUser': 'Default',
    'userDataFileNotExistOrReadFailed': 'User data file does not exist or read failed',
    'useDefaultUser': 'use default user',
    'usernameLoading': 'Username: Loading...',
    'removeUser': 'Remove User',
    'usernameExists': 'This username already exists, please use another username',
    'keepAtLeastOneUser': 'Keep at least one user',
    'cannotRemoveDefaultUser': 'Cannot remove default user',
    'confirmRemoveUser': 'Are you sure you want to delete user "%s" and its real-time data?',
    'removeUserFailed': 'Failed to remove user, please try again',
    'supportAndDonation': 'Support & Donation',
    'donationDesc1': 'Favorites Notes is a completely free and open-source software, dedicated to providing users with the best collection management experience.',
    'donationDesc2': 'If you find this software helpful and your financial conditions allow, welcome to support the developers through the following methods. Every support from you is the motivation for us to continue developing and improving!',
    'supportProject': '💖 Support Project Development 💖',
    'githubInfo': 'You can visit our GitHub project homepage to learn more about donation methods and project information:',
    'visitGithubProject': 'Visit GitHub Project',
    'donationMethodsInfo': 'All our donation methods have been integrated into the GitHub project page. If you want to support our development work, please visit the GitHub project homepage through the button above, where you can find multiple donation methods including Alipay.',
    'thankYouSupport': 'Thank you for your support, every encouragement from you is the motivation for us to move forward!',
    'aboutDeveloper': 'About Developer',
    'confirmDeleteFavorite': 'Are you sure you want to delete this favorite?',
    'favoriteDataNotLoaded': 'Favorite data not loaded',
    'cannotFindFavoriteItem': 'Cannot find favorite item',
    'editEpisodesError': 'Error when editing episodes',
    'dataEmptyAddFavorite': 'Data is empty, add favorite address',
    'noDownloadedItems': 'No downloaded items yet',
    'noDownloadingItems': 'No downloading items yet',
    'visit': 'Visit',
    'setEpisodes': 'Set Episodes',
    'action': 'Action',
    'downloadedLabel': 'Downloaded: ',
    'downloadedLabelShort': 'DL:',
    'fullyDownloaded': 'Fully Downloaded',
    'totalEpisodesShort': 'Tot:',
    'downloadedEpisodesShort': 'DL:'
  }
};

// 更新语言选择UI状态
function updateLanguageSelection(language, languageOptions) {
  if (languageOptions && languageOptions.length > 0) {
    languageOptions.forEach((option) => {
      option.classList.toggle(
        "active",
        option.dataset.language === language
      );
      // 添加选中样式
      if (option.classList.contains('active')) {
        option.style.borderColor = 'var(--primary-color)';
        option.style.backgroundColor = 'rgba(var(--primary-color-rgb), 0.1)';
      } else {
        option.style.borderColor = 'transparent';
        option.style.backgroundColor = 'var(--card-color)';
      }
    });
  }
}

// 更新页面标题
  function updatePageTitle(language) {
    const pageSpecificTitles = {
      'add-dialog.html': 'addDialogTitle',
      'edit-dialog.html': 'editDialogTitle',
      'username-dialog.html': 'usernameDialogTitle',
      'episode-dialog.html': 'episodeTitle',
      'about.html': 'aboutTitle',
      'favorite.html': 'favoritesTitle',
      'custom-window.html': 'customWindowTitle'
    };
  
  const currentPage = window.location.pathname.split('/').pop();
  if (pageSpecificTitles[currentPage]) {
    document.title = globalTranslations[language][pageSpecificTitles[currentPage]] || globalTranslations[language]['appTitle'] || '收藏夹记事本';
  } else {
    document.title = globalTranslations[language]['appTitle'] || '收藏夹记事本';
  }
}

// 更新页面上的所有翻译元素
function updatePageTranslations(language) {
  // 更新所有有data-i18n属性的元素
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.dataset.i18n;
    if (globalTranslations[language][key]) {
      element.textContent = globalTranslations[language][key];
    }
  });
  
  // 更新placeholder属性
  document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
    const key = element.dataset.i18nPlaceholder;
    if (globalTranslations[language][key]) {
      element.placeholder = globalTranslations[language][key];
    }
  });
  
  // 更新title属性
  document.querySelectorAll('[data-i18n-title]').forEach(element => {
    const key = element.dataset.i18nTitle;
    if (globalTranslations[language][key]) {
      element.title = globalTranslations[language][key];
    }
  });
  
  // 更新按钮文本
  const buttonsToUpdate = {
    //排除'#addBtn': 'addFavorite',
    '#copyBtn': 'copy',
    '.copy-btn': 'copy',
    '.cancel-btn': 'cancel',
    '.confirm-btn': 'confirm'
  };
  
  Object.entries(buttonsToUpdate).forEach(([selector, key]) => {
    const elements = document.querySelectorAll(selector);
    elements.forEach(element => {
      if (globalTranslations[language][key]) {
        element.textContent = globalTranslations[language][key];
      }
    });
  });
  
  // 更新搜索框占位符
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.placeholder = globalTranslations[language]['searchPlaceholder'] || '搜索收藏...';
  }
  
  // 更新地址栏占位符
  const addressInput = document.getElementById('addressInput');
  if (addressInput) {
    addressInput.placeholder = globalTranslations[language]['addressPlaceholder'] || '输入地址';
  }
  
  // 更新前往按钮
  const goBtn = document.getElementById('goBtn');
  if (goBtn) {
    goBtn.textContent = globalTranslations[language]['go'] || '前往';
  }
  
  // 更新收藏列表标题
  const listTitle = document.querySelector('h1');
  if (listTitle && listTitle.textContent.includes('Bookmark List')) {
    listTitle.textContent = globalTranslations[language]['bookmarkList'] || '收藏列表';
  }
  
  // 特殊处理：更新当前用户显示（即使它没有data-i18n属性）
  const currentUserDisplay = document.getElementById('currentUserDisplay');
  if (currentUserDisplay && currentUserDisplay.style.display !== 'none') {
    // 检查当前显示的文本是否包含用户信息
    const currentText = currentUserDisplay.textContent;
    const userMatch = currentText.match(/^(.*:\s*)(.+)$/);
    if (userMatch) {
      const username = userMatch[2];
      const userLabel = globalTranslations[language]['currentUser'] || '当前用户: ';
      currentUserDisplay.textContent = `${userLabel}${username}`;
    }
  }
  
  // 特殊处理：重新渲染收藏列表，确保列表区域的语言也更新
  if (window.favorites && Array.isArray(window.favorites) && typeof window.renderFavorites === 'function') {
    window.renderFavorites(window.favorites);
  }
}

// 获取当前语言设置
function getCurrentLanguage() {
  return localStorage.getItem('preferredLanguage') || 'zh-CN';
}

// 设置语言
function setLanguage(language) {
  localStorage.setItem('preferredLanguage', language);
  updatePageTitle(language);
  updatePageTranslations(language);
  return language;
}

// 初始化语言设置
function initializeLanguage() {
  const currentLanguage = getCurrentLanguage();
  updatePageTitle(currentLanguage);
  updatePageTranslations(currentLanguage);
  return currentLanguage;
}