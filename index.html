<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ”¶è—å¤¹è®°äº‹æœ¬</title>
    <link rel="stylesheet" href="colors.css" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="header">
      <h1>æ”¶è—å¤¹è®°äº‹æœ¬</h1>
      <div style="display: flex; gap: 10px; align-items: center;">
        <div class="search-container small-search">
          <input
            type="text"
            id="searchInput"
            placeholder="æœç´¢æ”¶è—..."
            class="search-input"
          />
          <button id="clearSearch" class="clear-search-btn">Ã—</button>
        </div>
        <button
          id="addBtn"
          style="background: none; border: none; cursor: pointer; font-size: 1.5rem"
        >
          â•
        </button>
        <button
          id="settingsBtn"
          style="background: none; border: none; cursor: pointer; font-size: 1.5rem"
        >
          âš™ï¸
        </button>
      </div>
    </div>
    <div class="main-content">
      <div class="tabs">
        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="downloading">
            ä¸‹è½½<span class="tab-count">(0)</span>
          </button>
          <button class="tab-btn" data-tab="downloaded">
            å·²ä¸‹è½½<span class="tab-count">(0)</span>
          </button>
        </div>
        <div class="tab-content active" id="downloadingList"></div>
        <div class="tab-content" id="downloadedList"></div>
      </div>
    </div>
    <div class="settings-view" id="settingsView">
      <div class="container">
        <button class="back-btn" id="backBtn">â† è¿”å›</button>
        <h2>è®¾ç½®</h2>
        <div class="settings-content">
          <!-- ç”¨æˆ·ç®¡ç†å¡ç‰‡ -->
          <div class="settings-card">
            <div class="settings-card-header">
              <h3>ç”¨æˆ·ç®¡ç†</h3>
            </div>
            <div class="settings-card-content">
              <div class="settings-item">
                <label class="settings-label">å½“å‰ç”¨æˆ·:</label>
                <div class="user-selection" id="userSelection">
                  <select id="userSelect" style="display: none;
                    background-color: var(--card-color);
                    color: var(--text-color);
                    padding: 8px 12px;
                    border: 1px solid var(--border-color);
                    border-radius: 6px;
                    font-size: 14px;
                  ">
                    <option value="default">é»˜è®¤ç”¨æˆ·</option>
                  </select>
                  <div id="currentUserDisplay" style="
                    display: flex;
                    align-items: center;
                    min-height: 36px;
                  ">ç”¨æˆ·åï¼šåŠ è½½ä¸­...</div>
                  <button
                    id="switchUserBtn"
                    style="display: none; margin-left: 10px;
                      background-color: var(--primary-color);
                      color: white;
                      border: none;
                      padding: 6px 12px;
                      border-radius: 6px;
                      cursor: pointer;
                      font-size: 14px;
                    "
                  >
                    åˆ‡æ¢ç”¨æˆ·
                  </button>
                </div>
              </div>
              
              <div class="settings-item">
                <label class="settings-label">ç®¡ç†ç”¨æˆ·:</label>
                <div class="user-management" style="display: flex; gap: 10px;">
                  <button id="addUserBtn" style="
                    background-color: var(--accent-color);
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background-color 0.3s ease;
                  ">æ·»åŠ ç”¨æˆ·</button>
                  <button
                    id="removeUserBtn"
                    style="margin-left: 0;
                      background-color: var(--error-color);
                      color: white;
                      border: none;
                      padding: 8px 16px;
                      border-radius: 6px;
                      cursor: pointer;
                      font-size: 14px;
                      transition: background-color 0.3s ease;
                    "
                  >
                    ç§»é™¤ç”¨æˆ·
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ç”¨æˆ·ç®¡ç†è„šæœ¬ -->
          <script>
            // ç”¨æˆ·ç®¡ç†åŠŸèƒ½å®ç°
            document.addEventListener("DOMContentLoaded", function () {
              // ç¡®ä¿ipcRendererå¯ç”¨
              const { ipcRenderer } = require("electron");
              const userSelect = document.getElementById("userSelect");
              const currentUserDisplay = document.getElementById(
                "currentUserDisplay"
              );
              const switchUserBtn = document.getElementById("switchUserBtn");
              const addUserBtn = document.getElementById("addUserBtn");
              const removeUserBtn = document.getElementById("removeUserBtn");

              // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
              let users = ["é»˜è®¤ç”¨æˆ·"];
              let currentUser = "é»˜è®¤ç”¨æˆ·";

              // è¯·æ±‚è·å–å½“å‰ç”¨æˆ·
              function getCurrentUser() {
                ipcRenderer.send("get-current-user");
              }

              // æ¥æ”¶å½“å‰ç”¨æˆ·å“åº”
              ipcRenderer.on("current-user-response", (event, user) => {
                if (user) {
                  currentUser = user;
                  // å·²è·å–å½“å‰ç”¨æˆ·
                  // å¦‚æœç”¨æˆ·æ•°æ®å·²ç»åŠ è½½ï¼Œåˆ™æ›´æ–°æ˜¾ç¤º
                  if (users.length > 0) {
                    updateUserDisplay();
                  }
                }
              });

              // æ¥æ”¶ä»ä¸»è¿›ç¨‹å‘é€çš„ç”¨æˆ·æ•°æ®
              ipcRenderer.on("users-data", (event, receivedUsers) => {
                if (
                  receivedUsers &&
                  Array.isArray(receivedUsers) &&
                  receivedUsers.length > 0
                ) {
                  users = receivedUsers;
                  // ç¡®ä¿å½“å‰ç”¨æˆ·å­˜åœ¨äºç”¨æˆ·åˆ—è¡¨ä¸­
                  if (!users.includes(currentUser)) {
                    currentUser = users[0];
                  }
                  updateUserDisplay();
                  // å·²æ¥æ”¶å¹¶æ›´æ–°ç”¨æˆ·æ•°æ®
                }
              });

              // åˆå§‹åŒ–æ—¶è·å–å½“å‰ç”¨æˆ·
              getCurrentUser();

              // æ›´æ–°ç”¨æˆ·æ˜¾ç¤º
              function updateUserDisplay() {
                if (users.length > 1) {
                  // å¤šç”¨æˆ·æ¨¡å¼
                  userSelect.style.display = "inline-block";
                  switchUserBtn.style.display = "inline-block";
                  currentUserDisplay.style.display = "none";
                  userSelect.innerHTML = "";
                  // ç¡®ä¿é»˜è®¤ç”¨æˆ·å§‹ç»ˆåœ¨ç¬¬ä¸€ä½
                  const sortedUsers = [...users];
                  const defaultUserIndex = sortedUsers.indexOf("é»˜è®¤ç”¨æˆ·");
                  if (defaultUserIndex > -1) {
                    // ç§»é™¤é»˜è®¤ç”¨æˆ·å¹¶æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
                    sortedUsers.splice(defaultUserIndex, 1);
                    sortedUsers.unshift("é»˜è®¤ç”¨æˆ·");
                  }

                  sortedUsers.forEach((user) => {
                    const option = document.createElement("option");
                    option.value = user;
                    option.textContent = user;
                    if (user === currentUser) option.selected = true;
                    userSelect.appendChild(option);
                  });
                } else {
                  // å•ç”¨æˆ·æ¨¡å¼
                  userSelect.style.display = "none";
                  switchUserBtn.style.display = "none";
                  currentUserDisplay.style.display = "block";
                  currentUserDisplay.textContent = `ç”¨æˆ·åï¼š${currentUser}`;
                }
              }

              // åˆ‡æ¢ç”¨æˆ·
              switchUserBtn.addEventListener("click", function () {
                currentUser = userSelect.value;
                // è¿™é‡Œåº”è¯¥ä¿å­˜å½“å‰ç”¨æˆ·é€‰æ‹©
                currentUserDisplay.textContent = `ç”¨æˆ·åï¼š${currentUser}`;
                updateUserDisplay();
                // å‘é€IPCæ¶ˆæ¯é€šçŸ¥ä¸»è¿›ç¨‹åˆ‡æ¢ç”¨æˆ·
                ipcRenderer.send("switch-user", currentUser);
              });

              // æ·»åŠ ç”¨æˆ·
              addUserBtn.addEventListener("click", function () {
                // ä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†æ·»åŠ ç”¨æˆ·
                ipcRenderer.send("open-username-dialog");
              });

              // ç›‘å¬ç”¨æˆ·åç¡®è®¤äº‹ä»¶
              ipcRenderer.on("username-confirmed", (event, username) => {
                if (username && username.trim() && !users.includes(username.trim())) {
                  const trimmedUsername = username.trim();
                  users.push(trimmedUsername);
                  currentUser = trimmedUsername;
                  updateUserDisplay();
                  // å‘é€IPCæ¶ˆæ¯é€šçŸ¥ä¸»è¿›ç¨‹æ·»åŠ ç”¨æˆ·å¹¶ä¿å­˜
                  ipcRenderer.send("add-user", trimmedUsername);
                } else if (username && users.includes(username.trim())) {
                  alert("è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ç”¨æˆ·å");
                }
              });

              // å¢å¼ºç§»é™¤ç”¨æˆ·åŠŸèƒ½ï¼Œæ·»åŠ ç¡®è®¤æç¤ºå¹¶ç¡®ä¿ç§»é™¤ååˆ‡æ¢åˆ°é»˜è®¤ç”¨æˆ·
              removeUserBtn.addEventListener("click", function () {
                if (users.length <= 1) {
                  alert("è‡³å°‘ä¿ç•™ä¸€ä¸ªç”¨æˆ·");
                  return;
                }
                const userToRemove = userSelect.value;
                if (userToRemove === "é»˜è®¤ç”¨æˆ·") {
                  alert("ä¸èƒ½ç§»é™¤é»˜è®¤ç”¨æˆ·");
                  return;
                }
                // å¼¹å‡ºç¡®è®¤æç¤º
                if (
                  !confirm(
                    `ç¡®å®šè¦åˆ é™¤ç”¨æˆ·"${userToRemove}"åŠå…¶å®æ—¶æ•°æ®å—ï¼Ÿ`
                  )
                ) {
                  return;
                }
                // å‘é€IPCæ¶ˆæ¯é€šçŸ¥ä¸»è¿›ç¨‹ç§»é™¤ç”¨æˆ·å¹¶ä¿å­˜
                // ä½¿ç”¨invokeæ›¿ä»£sendä»¥æ”¯æŒå¼‚æ­¥ç»“æœè¿”å›
                ipcRenderer
                  .invoke("remove-user", userToRemove)
                  .then((success) => {
                    if (success) {
                      users = users.filter((user) => user !== userToRemove);
                      // ç§»é™¤ç”¨æˆ·åï¼Œå°†å½“å‰ç”¨æˆ·è®¾ç½®ä¸ºé»˜è®¤ç”¨æˆ·
                      const defaultUserIndex = users.indexOf("é»˜è®¤ç”¨æˆ·");
                      currentUser =
                        defaultUserIndex > -1
                          ? "é»˜è®¤ç”¨æˆ·"
                          : users[0];
                      updateUserDisplay();
                    } else {
                      alert("ç§»é™¤ç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•");
                    }
                  });
              });

              // åˆå§‹åŒ–
              updateUserDisplay();
            });
          </script>

          <!-- ç•Œé¢è®¾ç½®å¡ç‰‡ -->
          <div class="settings-card">
            <div class="settings-card-header">
              <h3>ç•Œé¢è®¾ç½®</h3>
            </div>
            <div class="settings-card-content">
              <div class="settings-item">
                <label class="settings-label" for="windowMode">å¯åŠ¨çª—å£æ¨¡å¼:</label>
                <select id="windowMode" style="
                  width: 100%;
                  max-width: 200px;
                  background-color: var(--card-color);
                  color: var(--text-color);
                  padding: 8px 12px;
                  border: 1px solid var(--border-color);
                  border-radius: 6px;
                  font-size: 14px;
                ">
                  <option value="normal">çª—å£æ¨¡å¼</option>
                  <option value="maximized">æœ€å¤§åŒ–æ¨¡å¼</option>
                </select>
              </div>

              <div class="settings-item">
                <label class="settings-label">ä¸»é¢˜é€‰æ‹©</label>
                <div class="theme-selector" style="
                  display: flex;
                  gap: 12px;
                  flex-wrap: wrap;
                  padding: 10px 0;
                ">
                  <div
                    class="theme-option"
                    data-theme="default"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #2563eb;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    
                    ">
                  </div>
                  <div
                    class="theme-option"
                    data-theme="dark"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #0f172a;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    
                    ">
                  </div>
                  <div
                    class="theme-option"
                    data-theme="blue"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #1e40af;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    
                    ">
                  </div>
                  <div
                    class="theme-option"
                    data-theme="green"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #059669;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    
                    ">
                  </div>
                  <div
                    class="theme-option"
                    data-theme="purple"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #6b21a8;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    
                    ">
                  </div>
                  <div
                    class="theme-option"
                    data-theme="orange"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #c2410c;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    
                    ">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ç•Œé¢è®¾ç½®è„šæœ¬ -->
          <script>
            // ä¸»é¢˜é€‰æ‹©è®¾ç½® - ç¡®ä¿DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
            document.addEventListener("DOMContentLoaded", function () {
              // çª—å£æ¨¡å¼è®¾ç½®
              const windowModeSelect = document.getElementById("windowMode");

              // ä»ä¸»è¿›ç¨‹è·å–çª—å£æ¨¡å¼è®¾ç½®
              ipcRenderer.send("get-window-mode");
              ipcRenderer.on("window-mode-response", (event, mode) => {
                windowModeSelect.value = mode || "normal";
              });

              windowModeSelect.addEventListener("change", (e) => {
                const newMode = e.target.value;
                // ç¡®ä¿ipcRendererå¯ç”¨
                if (typeof ipcRenderer !== "undefined") {
                  ipcRenderer.send("update-window-mode", newMode);
                }
              });

              // ä¸»é¢˜é€‰æ‹©è®¾ç½®
              // ç®€åŒ–é€‰æ‹©å™¨ä»¥ç¡®ä¿èƒ½æ­£ç¡®è·å–æ‰€æœ‰ä¸»é¢˜é€‰é¡¹
              // è·å–æ‰€æœ‰ä¸»é¢˜é€‰é¡¹
              const themeOptions = document.querySelectorAll(".theme-option");

              // è·å–ä¿å­˜çš„ä¸»é¢˜
              const savedTheme = localStorage.getItem("theme") || "default";

              // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
              function applyTheme(theme) {
                if (theme === "default") {
                  document.documentElement.removeAttribute("data-theme");
                } else {
                  document.documentElement.setAttribute("data-theme", theme);
                }
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                if (themeOptions && themeOptions.length > 0) {
                  themeOptions.forEach((option) => {
                    option.classList.toggle(
                      "active",
                      option.dataset.theme === theme
                    );
                    // æ·»åŠ é€‰ä¸­åŠ¨ç”»æ•ˆæœ
                    if (option.classList.contains('active')) {
                      option.style.transform = 'scale(1.1)';
                      option.style.boxShadow = `0 0 0 3px var(--card-color), 0 0 0 5px var(--primary-color)`;
                    } else {
                      option.style.transform = 'scale(1)';
                      option.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    }
                  });
                }
              }

              // åˆå§‹åŒ–ä¸»é¢˜
              applyTheme(savedTheme);

              document.body.addEventListener("click", (e) => {
                // åŸºäºdata-themeå±æ€§è§¦å‘ï¼Œä¸ä¾èµ–ç±»å
                if (e.target.dataset.theme) {
                  const theme = e.target.dataset.theme;
                  if (theme) {
                    localStorage.setItem("theme", theme);
                    applyTheme(theme);
                    // æ˜¾ç¤ºä¸´æ—¶é€šçŸ¥
                    const notification = document.createElement("div");
                    notification.textContent = `å·²åˆ‡æ¢è‡³${theme}ä¸»é¢˜`;
                    notification.style.position = "fixed";
                    notification.style.top = "20px";
                    notification.style.left = "50%";
                    notification.style.transform = "translateX(-50%)";
                    notification.style.padding = "10px 20px";
                    notification.style.backgroundColor = "rgba(0,0,0,0.8)";
                    notification.style.color = "white";
                    notification.style.borderRadius = "5px";
                    notification.style.zIndex = "9999";
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 2000);
                  }
                }
              });
            });
          </script>

          <!-- æ•°æ®ç®¡ç†å¡ç‰‡ -->
          <div class="settings-card">
            <div class="settings-card-header">
              <h3>æ•°æ®ç®¡ç†</h3>
            </div>
            <div class="settings-card-content">
              <p style="
                margin-bottom: 20px;
                color: var(--text-color);
                line-height: 1.6;
              ">
                é€šè¿‡å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ï¼Œæ‚¨å¯ä»¥å¤‡ä»½æ”¶è—æ•°æ®æˆ–ä¸å…¶ä»–æµè§ˆå™¨æ”¶è—å¤¹è¿›è¡ŒåŒæ­¥ã€‚
              </p>
              <div style="
                display: flex;
                gap: 15px;
                margin-bottom: 15px;
                flex-wrap: wrap;
              ">
                <button id="importBtn" style="
                  background-color: var(--primary-color);
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: 500;
                  transition: all 0.3s ease;
                  min-width: 120px;
                ">å¯¼å…¥æ”¶è—å¤¹</button>
                <button id="exportBtn" style="
                  background-color: var(--accent-color);
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: 500;
                  transition: all 0.3s ease;
                  min-width: 120px;
                ">å¯¼å‡ºæ”¶è—å¤¹</button>
              </div>
            </div>
          </div>
          
          <!-- æ•°æ®ç®¡ç†è„šæœ¬ -->
          <script>
            // å¯¼å…¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById("importBtn").addEventListener("click", () => {
              ipcRenderer.send("import-favorites");
            });

            // å¯¼å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById("exportBtn").addEventListener("click", () => {
              ipcRenderer.send("export-favorites");
            });
          </script>

          <!-- å¯¼å…¥å¯¼å‡ºåŠŸèƒ½é€šçŸ¥ç»„ä»¶ -->
          <div
            id="importExportNotification"
            style="
              display: none;
              position: fixed;
              top: 20px;
              left: 50%;
              transform: translateX(-50%);
              padding: 12px 24px;
              border-radius: 8px;
              z-index: 9999;
              color: white;
              font-weight: bold;
              background-color: var(--primary-color);
              box-shadow: 0 4px 12px rgba(0,0,0,0.2);
              animation: slideIn 0.3s ease-out;
            "
          ></div>
          
          <style>
            /* å¡ç‰‡æ ·å¼ */
            .settings-card {
              background-color: var(--card-color);
              border-radius: 12px;
              margin-bottom: 24px;
              overflow: hidden;
              box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
              border: 1px solid var(--border-color);
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            
            .settings-card:hover {
              transform: translateY(-2px);
              box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            }
            
            .settings-card-header {
              background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1) 0%, rgba(var(--primary-rgb), 0.05) 100%);
              padding: 16px 20px;
              border-bottom: 1px solid var(--border-color);
            }
            
            .settings-card-header h3 {
              margin: 0;
              color: var(--primary-color);
              font-size: 18px;
              font-weight: 600;
            }
            
            .settings-card-content {
              padding: 20px;
            }
            
            .settings-item {
              margin-bottom: 20px;
            }
            
            .settings-item:last-child {
              margin-bottom: 0;
            }
            
            .settings-label {
              display: block;
              margin-bottom: 8px;
              color: var(--text-color);
              font-weight: 500;
              font-size: 14px;
            }
            
            /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
            button:hover {
              filter: brightness(1.05);
            }
            
            button:active {
              transform: scale(0.98);
            }
            
            /* é€šçŸ¥åŠ¨ç”» */
            @keyframes slideIn {
              from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
              }
              to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
              }
            }
          </style>

          <!-- æ”¯æŒä¸æèµ  -->
          <div class="settings-item" style="margin-bottom: 2rem;">
            <h3 style="margin-bottom: 15px; color: var(--primary-color); font-size: 1.2rem; font-weight: 600;">æ”¯æŒä¸æèµ </h3>
            <div class="donation-section" style="
              background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.05) 0%, rgba(var(--primary-rgb), 0.1) 100%);
              border: 2px solid rgba(var(--primary-rgb), 0.2);
              border-radius: 12px;
              padding: 20px;
              box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.1);
            ">
              <p style="margin-bottom: 15px; font-size: 1rem; line-height: 1.6; color: var(--text-color);">
                æ”¶è—å¤¹è®°äº‹æœ¬æ˜¯ä¸€æ¬¾å®Œå…¨å…è´¹çš„å¼€æºè½¯ä»¶ï¼Œæˆ‘ä»¬è‡´åŠ›äºä¸ºç”¨æˆ·æä¾›æœ€å¥½çš„æ”¶è—ç®¡ç†ä½“éªŒã€‚
              </p>
              <p style="margin-bottom: 20px; font-size: 1rem; line-height: 1.6; color: var(--text-color);">
                <strong style="color: var(--primary-color);">å¦‚æœæ‚¨è§‰å¾—è¿™æ¬¾è½¯ä»¶å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œå¹¶ä¸”ç»æµæ¡ä»¶å…è®¸ï¼Œæ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¯æŒå¼€å‘è€…ï¼Œæ‚¨çš„æ¯ä¸€ä»½æ”¯æŒéƒ½æ˜¯æˆ‘ä»¬ç»§ç»­å¼€å‘å’Œæ”¹è¿›çš„åŠ¨åŠ›ï¼</strong>
              </p>

              <div style="text-align: center; margin: 30px 0; background-color: var(--card-color); padding: 20px; border-radius: 8px; border: 1px dashed var(--accent-color);">
                <h4 style="margin-top: 0; margin-bottom: 15px; color: var(--accent-color); font-size: 1.1rem;">
                  ğŸ’– æ”¯æŒé¡¹ç›®å‘å±• ğŸ’–
                </h4>
                <p style="margin-bottom: 20px; font-size: 1rem;">
                  æ‚¨å¯ä»¥è®¿é—®æˆ‘ä»¬çš„ GitHub é¡¹ç›®ä¸»é¡µï¼Œäº†è§£æ›´å¤šæèµ æ–¹å¼å’Œé¡¹ç›®ä¿¡æ¯ï¼š
                </p>
                <button id="githubBtn" style="
                  padding: 12px 24px;
                  background-color: var(--accent-color);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 1rem;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  min-width: 180px;
                ">
                  è®¿é—® GitHub é¡¹ç›®
                </button>
              </div>

              <div style="background-color: rgba(var(--primary-rgb), 0.1); border-left: 4px solid var(--primary-color); padding: 15px; border-radius: 0 6px 6px 0; margin-top: 20px;">
                <p style="margin-bottom: 10px; font-size: 0.95rem;">
                  æˆ‘ä»¬çš„æ‰€æœ‰æèµ æ–¹å¼éƒ½å·²æ•´åˆåˆ° GitHub é¡¹ç›®é¡µé¢ä¸­ã€‚å¦‚æœæ‚¨æƒ³æ”¯æŒæˆ‘ä»¬çš„å¼€å‘å·¥ä½œï¼Œ
                  è¯·é€šè¿‡ä¸Šæ–¹æŒ‰é’®è®¿é—® GitHub é¡¹ç›®ä¸»é¡µï¼Œåœ¨é‚£é‡Œæ‚¨å¯ä»¥æ‰¾åˆ°åŒ…æ‹¬æ”¯ä»˜å®åœ¨å†…çš„å¤šç§æèµ æ–¹å¼ã€‚
                </p>
                <p style="text-align: center; margin-top: 15px; font-weight: 500; color: var(--primary-color);">
                  æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼Œæ‚¨çš„æ¯ä¸€ä»½é¼“åŠ±éƒ½æ˜¯æˆ‘ä»¬å‰è¿›çš„åŠ¨åŠ›ï¼
                </p>
              </div>
            </div>
          </div>
          <script>
            // GitHubæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById("githubBtn").addEventListener("click", () => {
              // ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æµè§ˆå™¨æ‰“å¼€GitHubé¡¹ç›®é¡µé¢
              ipcRenderer.send(
                "open-external-browser",
                "https://github.com/samson7s/favorites-browser"
              );
            });
          </script>
          <div class="settings-item">
            <button id="aboutBtn" class="save-btn">å…³äºå¼€å‘è€…</button>
            <script>
              document.getElementById("aboutBtn").addEventListener("click", () => {
                ipcRenderer.send("open-about-window");
              });
            </script>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      // è®¾ç½®è§†å›¾æ§åˆ¶
      const settingsBtn = document.getElementById("settingsBtn");
      const backBtn = document.getElementById("backBtn");
      const settingsView = document.getElementById("settingsView");
      const mainContent = document.querySelector(".main-content");
      const header = document.querySelector(".header");

      settingsBtn.addEventListener("click", () => {
        settingsView.style.display = "block";
        header.style.display = "none";
        mainContent.style.display = "none";
      });

      backBtn.addEventListener("click", () => {
        settingsView.style.display = "none";
        header.style.display = "flex";
        mainContent.style.display = "block";
      });

      // æ·»åŠ æ”¶è—ï¼ˆé€šè¿‡IPCå‘é€åˆ°ä¸»è¿›ç¨‹ï¼‰
      function addFavorite(title, url) {
        const finalTitle = title ? title : url;
        ipcRenderer.send("add-favorite", { title: finalTitle, url });
      }

      // åˆ é™¤æ”¶è—é¡¹ï¼ˆé€šè¿‡IPCå‘é€åˆ°ä¸»è¿›ç¨‹ï¼‰
      // åˆ›å»ºæ“ä½œèœå•æ§ä»¶çš„å·¥å‚å‡½æ•°
      function createActionMenu(items) {
        // åˆ›å»ºä¸»å®¹å™¨
        const container = document.createElement("div");
        container.className = "ActionMenu";

        // åˆ›å»ºæŒ‰é’®
        const button = document.createElement("button");
        button.className = "btn ActionMenu-button";
        button.style.marginLeft = "8px";
        button.style.height = "32px";
        button.style.fontSize = "14px";
        button.innerHTML = 'æ“ä½œ <span class="ActionMenu-caret"></span>';
        container.appendChild(button);

        // åˆ›å»ºä¸‹æ‹‰èœå•
        const dropdown = document.createElement("div");
        dropdown.className = "ActionMenu-dropdown";
        dropdown.style.display = "none";
        document.body.appendChild(dropdown);

        // æ·»åŠ èœå•é¡¹
        items.forEach((item, index) => {
          // æ·»åŠ åˆ†éš”çº¿ï¼ˆéç¬¬ä¸€é¡¹å‰ï¼‰
          if (index > 0) {
            const separator = document.createElement("div");
            separator.className = "ActionMenu-separator";
            dropdown.appendChild(separator);
          }

          const menuItem = document.createElement("button");
          menuItem.className = "ActionMenu-item";
          menuItem.textContent = item.label;
          menuItem.addEventListener("click", () => {
            item.onClick();
            toggleMenu(false); // ç‚¹å‡»åå…³é—­èœå•
          });
          dropdown.appendChild(menuItem);
        });

        // åˆ‡æ¢èœå•æ˜¾ç¤ºçŠ¶æ€
        function toggleMenu(show) {
          const wasOpen = dropdown.style.display === "block";
          const shouldOpen = show !== undefined ? show : !wasOpen;

          if (shouldOpen) {
            // å…³é—­æ‰€æœ‰å…¶ä»–æ‰“å¼€çš„èœå•
            document.querySelectorAll(".ActionMenu-dropdown").forEach((menu) => {
              if (menu !== dropdown) {
                menu.style.display = "none";
              }
            });
            dropdown.style.display = "block";
            const rect = button.getBoundingClientRect();
            const menuWidth = dropdown.offsetWidth || 200;
            const viewportWidth = window.innerWidth;
            const rightSpace = viewportWidth - rect.right;

            if (rightSpace < menuWidth) {
              dropdown.style.right = `${viewportWidth - rect.right}px`;
              dropdown.style.left = "auto";
            } else {
              dropdown.style.left = `${rect.left}px`;
              dropdown.style.right = "auto";
            }
            dropdown.style.top = `${rect.bottom}px`;

            const scrollContainer =
              document.querySelector(".downloading") || window;
            if (scrollContainer) {
              const handleScroll = () => {
                const newRect = button.getBoundingClientRect();
                const menuWidth =
                  dropdown.getBoundingClientRect().width || 200;
                const viewportWidth = window.innerWidth;
                const rightSpace = viewportWidth - newRect.right - 10;

                if (rightSpace < menuWidth) {
                  dropdown.style.right = `${viewportWidth - newRect.right}px`;
                  dropdown.style.left = "auto";
                } else {
                  dropdown.style.left = `${newRect.left}px`;
                  dropdown.style.right = "auto";
                }
                dropdown.style.top = `${newRect.bottom}px`;
              };
              scrollContainer.addEventListener("scroll", handleScroll);
              dropdown.handleScroll = handleScroll;
              dropdown.scrollContainer = scrollContainer;
            }
          } else {
            if (dropdown.scrollContainer && dropdown.handleScroll) {
              dropdown.scrollContainer.removeEventListener(
                "scroll",
                dropdown.handleScroll
              );
            }
            dropdown.style.display = "none";
            dropdown.dataset.open = "false";
          }
          container.classList.toggle("open", shouldOpen);
        }

        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        button.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleMenu();
        });

        // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­èœå•
        const closeOnOutsideClick = (e) => {
          if (!container.contains(e.target)) {
            toggleMenu(false);
          }
        };

        document.addEventListener("click", closeOnOutsideClick);

        // æ¸…ç†å‡½æ•°ï¼ˆå¯é€‰ï¼Œç”¨äºç»„ä»¶é”€æ¯æ—¶ï¼‰
        container.destroy = () => {
          document.removeEventListener("click", closeOnOutsideClick);
        };

        return container;
      }

      function closeAllActionMenus() {
        document.querySelectorAll(".ActionMenu-dropdown").forEach((menu) => {
          menu.style.display = "none";
        });
      }

      function deleteFavorite(index) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥æ”¶è—å—ï¼Ÿ")) return;
        ipcRenderer.send("delete-favorite", index);
      }

      window.showEditDialog = function (index) {
        ipcRenderer
          .invoke("show-edit-dialog", index)
          .then((result) => {
            if (result) {
              loadFavorites();
            }
          })
          .catch((err) => {
            console.error("Error showing edit dialog:", err);
          });
      };

      window.editEpisodes = function (index) {
        if (!window.favorites || !Array.isArray(window.favorites)) {
          alert("æ”¶è—æ•°æ®æœªåŠ è½½");
          return;
        }
        const item = window.favorites[index];
        if (!item) {
          alert("æ‰¾ä¸åˆ°æ”¶è—é¡¹");
          return;
        }

        ipcRenderer
          .invoke("show-episode-dialog", index)
          .then((result) => {
            if (!result || !result.success) return;
            const { total = 0, downloaded = 0 } = result;
            const totalNum =
              typeof total === "number" && !isNaN(total) ? total : 0;
            const downloadedNum =
              typeof downloaded === "number" && !isNaN(downloaded)
                ? downloaded
                : 0;
            if (downloadedNum > totalNum) {
              alert("å·²ä¸‹è½½é›†æ•°ä¸èƒ½å¤§äºæ€»é›†æ•°");
              return;
            }
            item.totalEpisodes = totalNum;
            item.downloadedEpisodes = downloadedNum;
            ipcRenderer.send("update-favorites", window.favorites);
            renderFavorites();
          })
          .catch((err) => {
            console.error("Error editing episodes:", err);
            alert("ç¼–è¾‘é›†æ•°æ—¶å‡ºé”™");
          });
      };

      let draggedIndex = null;

      // æ¸²æŸ“æ”¶è—åˆ—è¡¨ï¼ˆæ¥æ”¶ä¸»è¿›ç¨‹æ•°æ®ï¼‰
      function renderFavorites(favorites) {
        document.querySelectorAll(".ActionMenu").forEach((menu) => {
          menu.destroy?.();
          menu.remove();
        });
        document.querySelectorAll(".ActionMenu-dropdown").forEach((dropdown) => {
          dropdown.remove();
        });

        const isInitialRender = !window.hasRenderedFavorites;
        window.hasRenderedFavorites = true;

        if (isInitialRender) {
          favorites.forEach((item) => {
            item.isNew = false;
          });
        }

        // å¯¹æ”¶è—é¡¹è¿›è¡Œæ’åºï¼Œä½¿ç½®é¡¶é¡¹æ˜¾ç¤ºåœ¨æœ€å‰é¢
        const sortedFavorites = [...favorites].sort((a, b) => {
          // ç½®é¡¶é¡¹æ’åœ¨å‰é¢
          if (a.pinToTop && !b.pinToTop) return -1;
          if (!a.pinToTop && b.pinToTop) return 1;
          return 0;
        });

        window.favorites = favorites;
        const downloadingList = document.getElementById("downloadingList");
        const downloadedList = document.getElementById("downloadedList");

        downloadingList.innerHTML = "";
        downloadedList.innerHTML = "";

        const hasNewItems = favorites.some((item) => item.isNew);

        if (favorites.length === 0) {
          downloadingList.innerHTML =
            '<div class="empty-tip">æ•°æ®ä¸ºç©ºï¼Œæ·»åŠ æ”¶è—åœ°å€</div>';
          downloadedList.innerHTML =
            '<div class="empty-tip">æš‚æ— å·²ä¸‹è½½é¡¹ç›®</div>';
          return;
        } else {
          const newItemIndex = favorites.findIndex((item) => item.isNew);
          sortedFavorites.forEach((item, sortedIndex) => {
            // æ‰¾åˆ°åŸå§‹ç´¢å¼•ï¼Œç”¨äºæ“ä½œèœå•
            const originalIndex = favorites.findIndex(
              (fav) => fav.title === item.title && fav.url === item.url
            );
            const isNewItem = item.isNew && item.isNew === true;
            const { title, url } = item;
            const itemElement = document.createElement("div");
            itemElement.className = "favorite-item";
            // å¦‚æœæ˜¯ç½®é¡¶é¡¹ï¼Œæ·»åŠ ç½®é¡¶æ ‡è®°
            if (item.pinToTop) {
              itemElement.classList.add("pinned-item");
            }
            itemElement.draggable = true;
            itemElement.dataset.index = originalIndex;

            const titleSpan = document.createElement("span");
            titleSpan.style.flex = "1";
            titleSpan.style.wordBreak = "break-all";
            // ä¸ºç½®é¡¶é¡¹æ·»åŠ æ ‡è®°
            titleSpan.textContent = item.pinToTop ? "ğŸ“Œ " + title : title;
            itemElement.appendChild(titleSpan);

            const episodeBtn = document.createElement("button");
            episodeBtn.className = "btn episode-btn";
            episodeBtn.style.height = "32px";
            episodeBtn.style.fontSize = "14px";
            episodeBtn.textContent =
              item.totalEpisodes || 0 === 0
                ? item.downloadedEpisodes || 0 === 0
                  ? "è®¾ç½®é›†æ•°"
                  : `ä¸‹è½½: ${item.downloadedEpisodes || 0}`
                : item.totalEpisodes || 0 === item.downloadedEpisodes || 0
                ? "å·²ä¸‹è½½"
                : `æ€»é›†æ•°: ${item.totalEpisodes || 0}ï¼Œå·²ä¸‹è½½: ${
                    item.downloadedEpisodes || 0
                  }`;
            episodeBtn.addEventListener("click", async function () {
              const itemIndex = parseInt(
                this.closest(".favorite-item").dataset.index
              );
              await ipcRenderer.invoke("show-episode-dialog", itemIndex);
            });
            itemElement.appendChild(episodeBtn);

            const actionDiv = document.createElement("div");
            actionDiv.className = "action-buttons";

            const visitBtn = document.createElement("button");
            visitBtn.className = "btn visit-btn";
            visitBtn.style.height = "32px";
            visitBtn.style.fontSize = "14px";
            visitBtn.textContent = "è®¿é—®";
            visitBtn.addEventListener("click", () => {
              // æ£€æŸ¥æ˜¯å¦æœ‰openMethodå±æ€§ï¼Œå¹¶æ ¹æ®å±æ€§å€¼å†³å®šæ‰“å¼€æ–¹å¼
              if (item.openMethod && item.openMethod === "external") {
                // ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æµè§ˆå™¨æ‰“å¼€
                ipcRenderer.send("open-external-browser", url);
              } else {
                // ä½¿ç”¨å†…éƒ¨çª—å£æ‰“å¼€
                ipcRenderer.send("open-new-window", url);
              }
            });
            actionDiv.appendChild(visitBtn);

            const menu = createActionMenu([
              {
                label: "ç¼–è¾‘",
                onClick: () => {
                  showEditDialog(originalIndex);
                },
              },
              {
                label: "åˆ é™¤",
                onClick: () => deleteFavorite(originalIndex),
              },
            ]);
            actionDiv.appendChild(menu);

            itemElement.appendChild(actionDiv);

            if (isNewItem && !isInitialRender) {
              itemElement.classList.add("new-item");
              setTimeout(() => {
                item.isNew = false;
              }, 1000);
              requestAnimationFrame(() => {
                const container = document.body;
                container.scrollTo({
                  top: container.scrollHeight,
                  behavior: "smooth",
                });
              });
            }

            itemElement.addEventListener("dragstart", (e) => {
              draggedIndex = e.target.dataset.index;
              e.dataTransfer.effectAllowed = "move";
              e.target.classList.add("dragging");
            });

            itemElement.addEventListener("dragend", (e) => {
              e.target.classList.remove("dragging");
            });

            itemElement.addEventListener("dragover", (e) => {
              e.preventDefault();
              e.dataTransfer.dropEffect = "move";
            });

            itemElement.addEventListener("drop", (e) => {
              e.preventDefault();
              const targetIndex = e.target
                .closest(".favorite-item")
                .dataset.index;
              if (draggedIndex !== targetIndex) {
                [favorites[draggedIndex], favorites[targetIndex]] = [
                  favorites[targetIndex],
                  favorites[draggedIndex],
                ];
                ipcRenderer.send("update-favorites-order", favorites);
                renderFavorites(favorites);
              }
            });

            const total = item.totalEpisodes || 0;
            const downloaded = item.downloadedEpisodes || 0;

            if (total > 0 && total === downloaded) {
              downloadedList.appendChild(itemElement);
            } else {
              downloadingList.appendChild(itemElement);
            }
          });

          if (downloadingList.children.length === 0) {
            downloadingList.innerHTML =
              '<div class="empty-tip">æš‚æ— ä¸‹è½½ä¸­é¡¹ç›®</div>';
          }
          if (downloadedList.children.length === 0) {
            downloadedList.innerHTML =
              '<div class="empty-tip">æš‚æ— å·²ä¸‹è½½é¡¹ç›®</div>';
          }

          document.querySelectorAll(".tab-btn").forEach((btn) =>
            btn.classList.remove("active")
          );
          document
            .querySelector('.tab-btn[data-tab="downloading"]')
            .classList.add("active");
        }
      }

      // åˆå§‹åŒ–ï¼šè¯·æ±‚åŠ è½½æ”¶è—
      ipcRenderer.send("get-favorites");
      // æ¥æ”¶æ”¶è—æ›´æ–°äº‹ä»¶
      ipcRenderer.on("favorites-updated", (event, favorites) => {
        renderFavorites(favorites);
        // åŒæ—¶æ›´æ–°æ ‡ç­¾é¡µè®¡æ•°
        updateTabCounts();
      });

      // æ ‡ç­¾åˆ‡æ¢é€»è¾‘
      document.querySelectorAll(".tab-btn").forEach((button) => {
        button.addEventListener("click", () => {
          document.querySelectorAll(".tab-btn").forEach((btn) =>
            btn.classList.remove("active")
          );
          button.classList.add("active");

          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.remove("active");
          });

          const tabId = button.dataset.tab;
          document.getElementById(`${tabId}List`).classList.add("active");
        });
      });

      // æœç´¢åŠŸèƒ½å®ç°
      const searchInput = document.getElementById("searchInput");

      function updateTabCounts() {
        const searchTerm = searchInput.value.toLowerCase();
        const allItems = document.querySelectorAll(".favorite-item");
        let downloadingCount = 0,
          downloadedCount = 0;

        allItems.forEach((item) => {
          const isVisible = item.style.display !== "none";
          if (!isVisible) return;

          // æ£€æŸ¥é¡¹ç›®æ˜¯å¦å±äºå·²ä¸‹è½½ç±»åˆ«
          const titleSpan = item.querySelector("span");
          const itemIndex = parseInt(item.dataset.index);
          const itemData = window.favorites && window.favorites[itemIndex];
          const isDownloaded =
            itemData &&
            itemData.totalEpisodes &&
            itemData.totalEpisodes === itemData.downloadedEpisodes;

          if (isDownloaded) downloadedCount++;
          else downloadingCount++;
        });

        // æ›´æ–°æ ‡ç­¾é¡µè®¡æ•°
        document.querySelector(
          '[data-tab="downloading"] .tab-count'
        ).textContent = `(${downloadingCount})`;
        document.querySelector(
          '[data-tab="downloaded"] .tab-count'
        ).textContent = `(${downloadedCount})`;
      }

      function filterFavorites() {
        const searchTerm = searchInput.value.toLowerCase();
        const favorites = document.querySelectorAll(".favorite-item");
        const hasSearchTerm = !!searchTerm;

        // æ˜¾ç¤º/éšè—æ¸…ç©ºæŒ‰é’®
        document.getElementById("clearSearch").style.display = hasSearchTerm
          ? "block"
          : "none";

        favorites.forEach((favorite) => {
          const title = favorite.querySelector("span").textContent.toLowerCase();
          const shouldShow = !hasSearchTerm || title.includes(searchTerm);
          favorite.style.display = shouldShow ? "flex" : "none";
        });

        // æ›´æ–°æ ‡ç­¾é¡µè®¡æ•°
        updateTabCounts();
      }

      // ä¸ºæœç´¢æ¡†æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬
      // æœç´¢æ¡†äº‹ä»¶ç›‘å¬
      searchInput.addEventListener("input", filterFavorites);

      // æ¸…ç©ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById("clearSearch").addEventListener("click", () => {
        searchInput.value = "";
        filterFavorites();
      });

      // åˆå§‹åŠ è½½æ—¶æ›´æ–°è®¡æ•°
      document.addEventListener("DOMContentLoaded", updateTabCounts);

      // æ–°æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById("addBtn").addEventListener("click", () => {
        ipcRenderer.send("open-add-dialog");
      });

      // å¤„ç†å¯¼å…¥å¯¼å‡ºé€šçŸ¥
      ipcRenderer.on("import-export-notification", (event, data) => {
        const notification = document.getElementById("importExportNotification");

        // è®¾ç½®é€šçŸ¥æ ·å¼å’Œå†…å®¹
        notification.style.display = "block";
        notification.style.backgroundColor =
          data.type === "success" ? "#4caf50" : "#f44336";
        notification.textContent = data.message;

        // 3ç§’åè‡ªåŠ¨éšè—é€šçŸ¥
        setTimeout(() => {
          notification.style.display = "none";
        }, 3000);
      });
    </script>
  </body>
</html>