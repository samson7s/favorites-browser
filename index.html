<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ”¶è—å¤¹è®°äº‹æœ¬</title>
    <link rel="stylesheet" href="colors.css" />
    <link rel="stylesheet" href="styles.css" />
    <script src="language.js"></script>
  </head>
  <body>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        initializeLanguage();
      });
    </script>
    <div class="header">
      <div style="display: flex; align-items: center;">
        <img
          src="assets/images/logo.svg"
          alt="Logo"
          class="app-logo"
          style="margin-right: 3px; margin-left: -5px; width: 40px; height: 40px"
        />
        <h1 data-i18n="appTitle" style="font-size: 18px; user-select: none"></h1>
      </div>
      <div style="display: flex; gap: 10px; align-items: center">
        <div class="search-container small-search">
          <input
            type="text"
            id="searchInput"
            placeholder="æœç´¢æ”¶è—..."
            class="search-input"
          />
          <button id="clearSearch" class="clear-search-btn">Ã—</button>
        </div>
        <button
          id="addBtn"
          style="background: none; border: none; cursor: pointer; font-size: 1.2rem"
        >
          â•
        </button>
        <button
          id="settingsBtn"
          style="background: none; border: none; cursor: pointer; font-size: 1.2rem"
        >
          âš™ï¸
        </button>
      </div>
    </div>
    <div class="main-content">
      <div class="tabs">
        <div class="tab-buttons">
          <button class="tab-btn active" data-tab="downloading">
            <span data-i18n="downloadingTab"></span
            ><span class="tab-count">(0)</span>
          </button>
          <button class="tab-btn" data-tab="downloaded">
            <span data-i18n="downloadedTab"></span
            ><span class="tab-count">(0)</span>
          </button>
        </div>
        <div class="tab-content active" id="downloadingList"></div>
        <div class="tab-content" id="downloadedList"></div>
      </div>
    </div>
    <div class="settings-view" id="settingsView">
      <div class="container">
        <button class="back-btn" id="backBtn">
          â† <span data-i18n="backButton">è¿”å›</span>
        </button>
        <h2 data-i18n="settingsTitle">è®¾ç½®</h2>
        <div class="settings-content">
          <!-- ç”¨æˆ·ç®¡ç†å¡ç‰‡ -->
          <div class="settings-card">
            <div class="settings-card-header">
              <h3 data-i18n="userManagement">ç”¨æˆ·ç®¡ç†</h3>
            </div>
            <div class="settings-card-content">
              <div class="settings-item">
                <div class="user-selection" id="userSelection">
                  <select
                    id="userSelect"
                    style="
                      display: none;
                      background-color: var(--card-color);
                      color: var(--text-color);
                      padding: 8px 12px;
                      border: 1px solid var(--border-color);
                      border-radius: 6px;
                      font-size: 14px;
                    "
                  >
                    <option value="default">Default</option>
                  </select>
                  <div
                    id="currentUserDisplay"
                    style="display: flex; align-items: center"
                    data-i18n="usernameLoading"
                  >
                    ç”¨æˆ·åï¼šåŠ è½½ä¸­...
                  </div>
                  <button
                    id="switchUserBtn"
                    style="
                      display: none;
                      margin-left: 10px;
                      background-color: var(--primary-color);
                      color: white;
                      border: none;
                      padding: 6px 12px;
                      border-radius: 6px;
                      cursor: pointer;
                      font-size: 14px;
                    "
                    data-i18n="switchUser"
                  >
                    åˆ‡æ¢ç”¨æˆ·
                  </button>
                </div>
              </div>

              <div class="settings-item">
                <label class="settings-label" data-i18n="userManagement">
                  ç®¡ç†ç”¨æˆ·:
                </label>
                <div class="user-management" style="display: flex; gap: 10px">
                  <button
                    id="addUserBtn"
                    style="
                      background-color: var(--accent-color);
                      color: white;
                      border: none;
                      padding: 8px 16px;
                      border-radius: 6px;
                      cursor: pointer;
                      font-size: 14px;
                      transition: background-color 0.3s ease;
                    "
                    data-i18n="addUser"
                  >
                    æ·»åŠ ç”¨æˆ·
                  </button>
                  <button
                    id="removeUserBtn"
                    style="
                      margin-left: 0;
                      background-color: var(--error-color);
                      color: white;
                      border: none;
                      padding: 8px 16px;
                      border-radius: 6px;
                      cursor: pointer;
                      font-size: 14px;
                      transition: background-color 0.3s ease;
                    "
                    data-i18n="removeUser"
                  >
                    ç§»é™¤ç”¨æˆ·
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ç”¨æˆ·ç®¡ç†è„šæœ¬ -->
          <script>
            // ç”¨æˆ·ç®¡ç†åŠŸèƒ½å®ç°
            document.addEventListener("DOMContentLoaded", function () {
              // ç¡®ä¿ipcRendererå¯ç”¨
              const { ipcRenderer } = require("electron");
              const userSelect = document.getElementById("userSelect");
              const currentUserDisplay = document.getElementById(
                "currentUserDisplay"
              );
              const switchUserBtn = document.getElementById("switchUserBtn");
              const addUserBtn = document.getElementById("addUserBtn");
              const removeUserBtn = document.getElementById("removeUserBtn");

              // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
              let users = ["Default"];
              let currentUser = "Default";

              // è¯·æ±‚è·å–å½“å‰ç”¨æˆ·
              function getCurrentUser() {
                ipcRenderer.send("get-current-user");
              }

              // æ¥æ”¶å½“å‰ç”¨æˆ·å“åº”
              ipcRenderer.on("current-user-response", (event, user) => {
                if (user) {
                  currentUser = user;
                  // å·²è·å–å½“å‰ç”¨æˆ·
                  // å¦‚æœç”¨æˆ·æ•°æ®å·²ç»åŠ è½½ï¼Œåˆ™æ›´æ–°æ˜¾ç¤º
                  if (users.length > 0) {
                    updateUserDisplay();
                  }
                }
              });

              // æ¥æ”¶ä»ä¸»è¿›ç¨‹å‘é€çš„ç”¨æˆ·æ•°æ®
              ipcRenderer.on("users-data", (event, receivedUsers) => {
                if (
                  receivedUsers &&
                  Array.isArray(receivedUsers) &&
                  receivedUsers.length > 0
                ) {
                  users = receivedUsers;
                  // ç¡®ä¿å½“å‰ç”¨æˆ·å­˜åœ¨äºç”¨æˆ·åˆ—è¡¨ä¸­
                  if (!users.includes(currentUser)) {
                    currentUser = users[0];
                  }
                  updateUserDisplay();
                  // å·²æ¥æ”¶å¹¶æ›´æ–°ç”¨æˆ·æ•°æ®
                }
              });

              // åˆå§‹åŒ–æ—¶è·å–å½“å‰ç”¨æˆ·
              getCurrentUser();

              // æ›´æ–°ç”¨æˆ·æ˜¾ç¤º
              function updateUserDisplay() {
                if (users.length > 1) {
                  // å¤šç”¨æˆ·æ¨¡å¼
                  userSelect.style.display = "inline-block";
                  switchUserBtn.style.display = "inline-block";
                  currentUserDisplay.style.display = "none";
                  userSelect.innerHTML = "";
                  // ç¡®ä¿é»˜è®¤ç”¨æˆ·å§‹ç»ˆåœ¨ç¬¬ä¸€ä½
                  const sortedUsers = [...users];
                  const defaultUserIndex = sortedUsers.indexOf("Default");
                  if (defaultUserIndex > -1) {
                    // ç§»é™¤é»˜è®¤ç”¨æˆ·å¹¶æ·»åŠ åˆ°æ•°ç»„å¼€å¤´
                    sortedUsers.splice(defaultUserIndex, 1);
                    sortedUsers.unshift("Default");
                  }

                  sortedUsers.forEach((user) => {
                    const option = document.createElement("option");
                    option.value = user;
                    option.textContent = user;
                    if (user === currentUser) option.selected = true;
                    userSelect.appendChild(option);
                  });
                } else {
                  // å•ç”¨æˆ·æ¨¡å¼
                  userSelect.style.display = "none";
                  switchUserBtn.style.display = "none";
                  currentUserDisplay.style.display = "block";
                  // ä¿æŒdata-i18nå±æ€§ï¼Œæ­£ç¡®è®¾ç½®ç”¨æˆ·åå­—ç¬¦ä¸²
                  const language = getCurrentLanguage();
                  const userLabel =
                    globalTranslations[language]["currentUser"] || "å½“å‰ç”¨æˆ·: ";
                  currentUserDisplay.textContent = `${userLabel}${currentUser}`;
                  // ç§»é™¤ä¹‹å‰çš„data-i18nå±æ€§ï¼Œå› ä¸ºç°åœ¨æ˜¾ç¤ºçš„æ˜¯ç”¨æˆ·åè€Œä¸æ˜¯åŠ è½½çŠ¶æ€
                  currentUserDisplay.removeAttribute("data-i18n");
                }
              }

              // åˆ‡æ¢ç”¨æˆ·
              switchUserBtn.addEventListener("click", function () {
                currentUser = userSelect.value;
                // è¿™é‡Œåº”è¯¥ä¿å­˜å½“å‰ç”¨æˆ·é€‰æ‹©
                // ç›´æ¥è°ƒç”¨updateUserDisplayæ¥æ›´æ–°æ˜¾ç¤ºï¼Œç¡®ä¿ä½¿ç”¨å›½é™…åŒ–æ–‡æœ¬
                updateUserDisplay();
                // å‘é€IPCæ¶ˆæ¯é€šçŸ¥ä¸»è¿›ç¨‹åˆ‡æ¢ç”¨æˆ·
                ipcRenderer.send("switch-user", currentUser);
              });

              // æ·»åŠ ç”¨æˆ·
              addUserBtn.addEventListener("click", function () {
                // ä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†æ·»åŠ ç”¨æˆ·
                ipcRenderer.send("open-username-dialog");
              });

              // ç›‘å¬ç”¨æˆ·åç¡®è®¤äº‹ä»¶
              ipcRenderer.on("username-confirmed", (event, username) => {
                if (username && username.trim() && !users.includes(username.trim())) {
                  const trimmedUsername = username.trim();
                  users.push(trimmedUsername);
                  currentUser = trimmedUsername;
                  updateUserDisplay();
                  // å‘é€IPCæ¶ˆæ¯é€šçŸ¥ä¸»è¿›ç¨‹æ·»åŠ ç”¨æˆ·å¹¶ä¿å­˜
                  ipcRenderer.send("add-user", trimmedUsername);
                } else if (username && users.includes(username.trim())) {
                  const language = getCurrentLanguage();
                  alert(
                    globalTranslations[language]["usernameExists"] ||
                      "è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ç”¨æˆ·å"
                  );
                }
              });

              // å¢å¼ºç§»é™¤ç”¨æˆ·åŠŸèƒ½ï¼Œæ·»åŠ ç¡®è®¤æç¤ºå¹¶ç¡®ä¿ç§»é™¤ååˆ‡æ¢åˆ°é»˜è®¤ç”¨æˆ·
              removeUserBtn.addEventListener("click", function () {
                const language = getCurrentLanguage();
                if (users.length <= 1) {
                  alert(
                    globalTranslations[language]["keepAtLeastOneUser"] ||
                      "è‡³å°‘ä¿ç•™ä¸€ä¸ªç”¨æˆ·"
                  );
                  return;
                }
                const userToRemove = userSelect.value;
                if (userToRemove === "Default") {
                  alert(
                    globalTranslations[language]["cannotRemoveDefaultUser"] ||
                      "ä¸èƒ½ç§»é™¤é»˜è®¤ç”¨æˆ·"
                  );
                  return;
                }
                // å¼¹å‡ºç¡®è®¤æç¤ºï¼Œæ”¯æŒå ä½ç¬¦æ›¿æ¢
                const confirmMsg =
                  (globalTranslations[language]["confirmRemoveUser"] ||
                    'ç¡®å®šè¦åˆ é™¤ç”¨æˆ·"%s"åŠå…¶å®æ—¶æ•°æ®å—ï¼Ÿ').replace(
                    "%s",
                    userToRemove
                  );
                if (!confirm(confirmMsg)) {
                  return;
                }
                // å‘é€IPCæ¶ˆæ¯é€šçŸ¥ä¸»è¿›ç¨‹ç§»é™¤ç”¨æˆ·å¹¶ä¿å­˜
                // ä½¿ç”¨invokeæ›¿ä»£sendä»¥æ”¯æŒå¼‚æ­¥ç»“æœè¿”å›
                ipcRenderer
                  .invoke("remove-user", userToRemove)
                  .then((success) => {
                    if (success) {
                      users = users.filter((user) => user !== userToRemove);
                      // ç§»é™¤ç”¨æˆ·åï¼Œå°†å½“å‰ç”¨æˆ·è®¾ç½®ä¸ºé»˜è®¤ç”¨æˆ·
                      const defaultUserIndex = users.indexOf("Default");
                      currentUser =
                        defaultUserIndex > -1 ? "Default" : users[0];
                      updateUserDisplay();
                    } else {
                      const language = getCurrentLanguage();
                      alert(
                        globalTranslations[language]["removeUserFailed"] ||
                          "ç§»é™¤ç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•"
                      );
                    }
                  });
              });

              // åˆå§‹åŒ–
              updateUserDisplay();
            });
          </script>

          <!-- ç•Œé¢è®¾ç½®å¡ç‰‡ -->
          <div class="settings-card">
            <div class="settings-card-header">
              <h3 data-i18n="interfaceSettings">ç•Œé¢è®¾ç½®</h3>
            </div>
            <div class="settings-card-content">
              <div class="settings-item">
                <label class="settings-label" for="windowMode" data-i18n="windowMode">
                  å¯åŠ¨çª—å£æ¨¡å¼:
                </label>
                <select
                  id="windowMode"
                  style="
                    width: 100%;
                    max-width: 200px;
                    background-color: var(--card-color);
                    color: var(--text-color);
                    padding: 8px 12px;
                    border: 1px solid var(--border-color);
                    border-radius: 6px;
                    font-size: 14px;
                  "
                >
                  <option value="normal" data-i18n="normalWindow">çª—å£æ¨¡å¼</option>
                  <option value="maximized" data-i18n="maximizedWindow">
                    æœ€å¤§åŒ–æ¨¡å¼
                  </option>
                </select>
              </div>

              <div class="settings-item">
                <label class="settings-label" data-i18n="themeSelection">
                  ä¸»é¢˜é€‰æ‹©
                </label>
                <div
                  class="theme-selector"
                  style="
                    display: flex;
                    gap: 12px;
                    flex-wrap: wrap;
                    padding: 10px 0;
                  "
                >
                  <div
                    class="theme-option"
                    data-theme="default"
                    data-i18n-title="defaultTheme"
                    title="é»˜è®¤ä¸»é¢˜"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #2563eb;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    "
                  ></div>
                  <div
                    class="theme-option"
                    data-theme="dark"
                    data-i18n-title="darkTheme"
                    title="æš—é»‘ä¸»é¢˜"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #0f172a;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    "
                  ></div>
                  <div
                    class="theme-option"
                    data-theme="blue"
                    data-i18n-title="blueTheme"
                    title="è“è‰²ä¸»é¢˜"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #1e40af;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    "
                  ></div>
                  <div
                    class="theme-option"
                    data-theme="green"
                    data-i18n-title="greenTheme"
                    title="ç»¿è‰²ä¸»é¢˜"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #059669;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    "
                  ></div>
                  <div
                    class="theme-option"
                    data-theme="purple"
                    data-i18n-title="purpleTheme"
                    title="ç´«è‰²ä¸»é¢˜"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #6b21a8;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    "
                  ></div>
                  <div
                    class="theme-option"
                    data-theme="orange"
                    data-i18n-title="orangeTheme"
                    title="æ©™è‰²ä¸»é¢˜"
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: #c2410c;
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    "
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <!-- ç•Œé¢è®¾ç½®è„šæœ¬ -->
          <script>
            // ä¸»é¢˜é€‰æ‹©è®¾ç½® - ç¡®ä¿DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
            document.addEventListener("DOMContentLoaded", function () {
              // çª—å£æ¨¡å¼è®¾ç½®
              const windowModeSelect = document.getElementById("windowMode");

              // ä»ä¸»è¿›ç¨‹è·å–çª—å£æ¨¡å¼è®¾ç½®
              ipcRenderer.send("get-window-mode");
              ipcRenderer.on("window-mode-response", (event, mode) => {
                windowModeSelect.value = mode || "normal";
              });

              windowModeSelect.addEventListener("change", (e) => {
                const newMode = e.target.value;
                // ç¡®ä¿ipcRendererå¯ç”¨
                if (typeof ipcRenderer !== "undefined") {
                  ipcRenderer.send("update-window-mode", newMode);
                }
              });

              // ä¸»é¢˜é€‰æ‹©è®¾ç½®
              // ç®€åŒ–é€‰æ‹©å™¨ä»¥ç¡®ä¿èƒ½æ­£ç¡®è·å–æ‰€æœ‰ä¸»é¢˜é€‰é¡¹
              // è·å–æ‰€æœ‰ä¸»é¢˜é€‰é¡¹
              const themeOptions = document.querySelectorAll(".theme-option");

              // è·å–ä¿å­˜çš„ä¸»é¢˜
              const savedTheme = localStorage.getItem("theme") || "default";

              // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
              function applyTheme(theme) {
                if (theme === "default") {
                  document.documentElement.removeAttribute("data-theme");
                } else {
                  document.documentElement.setAttribute("data-theme", theme);
                }
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                if (themeOptions && themeOptions.length > 0) {
                  themeOptions.forEach((option) => {
                    option.classList.toggle(
                      "active",
                      option.dataset.theme === theme
                    );
                    // æ·»åŠ é€‰ä¸­åŠ¨ç”»æ•ˆæœ
                    if (option.classList.contains("active")) {
                      option.style.transform = "scale(1.1)";
                      option.style.boxShadow =
                        "0 0 0 3px var(--card-color), 0 0 0 5px var(--primary-color)";
                    } else {
                      option.style.transform = "scale(1)";
                      option.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
                    }
                  });
                }
              }

              // åˆå§‹åŒ–ä¸»é¢˜
              applyTheme(savedTheme);

              document.body.addEventListener("click", (e) => {
                // åŸºäºdata-themeå±æ€§è§¦å‘ï¼Œä¸ä¾èµ–ç±»å
                if (e.target.dataset.theme) {
                  const theme = e.target.dataset.theme;
                  if (theme) {
                    localStorage.setItem("theme", theme);
                    applyTheme(theme);
                    // æ˜¾ç¤ºä¸´æ—¶é€šçŸ¥ - å›½é™…åŒ–å¤„ç†
                    const notification = document.createElement("div");
                    const currentLang = getCurrentLanguage();
                    const themeText =
                      theme.charAt(0).toUpperCase() + theme.slice(1);
                    notification.textContent = globalTranslations[currentLang][
                      "themeSwitched"
                    ].replace("%s", themeText);
                    notification.style.position = "fixed";
                    notification.style.top = "20px";
                    notification.style.left = "50%";
                    notification.style.transform = "translateX(-50%)";
                    notification.style.padding = "10px 20px";
                    notification.style.backgroundColor = "rgba(0,0,0,0.8)";
                    notification.style.color = "white";
                    notification.style.borderRadius = "5px";
                    notification.style.zIndex = "9999";
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 2000);
                  }
                }
              });
            });
          </script>

          <!-- è¯­è¨€è®¾ç½®å¡ç‰‡ -->
          <div class="settings-card">
            <div class="settings-card-header">
              <h3 data-i18n="languageSettings">è¯­è¨€è®¾ç½®</h3>
            </div>
            <div class="settings-card-content">
              <div class="settings-item">
                <label class="settings-label" data-i18n="interfaceLanguage">
                  ç•Œé¢è¯­è¨€
                </label>
                <div
                  class="language-selector"
                  style="
                    display: flex;
                    gap: 12px;
                    flex-wrap: wrap;
                    padding: 10px 0;
                  "
                >
                  <div
                    class="language-option"
                    data-language="zh-CN"
                    style="
                      padding: 8px 16px;
                      border-radius: 6px;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: var(--card-color);
                      color: var(--text-color);
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    "
                    data-i18n="simplifiedChinese"
                  >
                    ç®€ä½“ä¸­æ–‡
                  </div>
                  <div
                    class="language-option"
                    data-language="en"
                    style="
                      padding: 8px 16px;
                      border-radius: 6px;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      background-color: var(--card-color);
                      color: var(--text-color);
                      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    "
                    data-i18n="english"
                  >
                    English
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- è¯­è¨€è®¾ç½®è„šæœ¬ -->
          <script>
            // è¯­è¨€é€‰æ‹©è®¾ç½® - ç¡®ä¿DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
            document.addEventListener("DOMContentLoaded", function () {
              // è·å–æ‰€æœ‰è¯­è¨€é€‰é¡¹
              const languageOptions = document.querySelectorAll(".language-option");

              // è·å–ä¿å­˜çš„è¯­è¨€æˆ–ä½¿ç”¨é»˜è®¤è¯­è¨€
              // ä¿æŒä¸å…¨å±€å‡½æ•°å…¼å®¹ï¼Œä½¿ç”¨ç›¸åŒçš„localStorageé”®
              const savedLanguage =
                localStorage.getItem("preferredLanguage") || "zh-CN";

              // å¦‚æœä¹‹å‰ä½¿ç”¨äº†"language"é”®ï¼Œè¿ç§»æ•°æ®
              const oldLanguage = localStorage.getItem("language");
              if (oldLanguage && !savedLanguage) {
                localStorage.setItem("preferredLanguage", oldLanguage);
              }

              // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©
              updateLanguageSelection(savedLanguage, languageOptions);
              // åˆå§‹åŒ–é¡µé¢æ ‡é¢˜
              initializeLanguage();

              // è¯­è¨€é€‰æ‹©ç‚¹å‡»äº‹ä»¶ - å®ç°æ ‡é¢˜åˆ‡æ¢åŠŸèƒ½
              document.body.addEventListener("click", (e) => {
                if (
                  e.target.classList.contains("language-option") ||
                  e.target.closest(".language-option")
                ) {
                  const languageOption = e.target.classList.contains(
                    "language-option"
                  )
                    ? e.target
                    : e.target.closest(".language-option");
                  const language = languageOption.dataset.language;

                  // ä¿å­˜è¯­è¨€è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
                  localStorage.setItem("preferredLanguage", language);

                  // æ›´æ–°UIé€‰æ‹©çŠ¶æ€
                  updateLanguageSelection(language, languageOptions);

                  // æ›´æ–°é¡µé¢æ ‡é¢˜
                  updatePageTitle(language);

                  // æ›´æ–°é¡µé¢æ‰€æœ‰ç¿»è¯‘å…ƒç´ 
                  updatePageTranslations(language);

                  // æ˜¾ç¤ºä¸´æ—¶é€šçŸ¥
                  const notification = document.createElement("div");
                  const languageName =
                    language === "zh-CN"
                      ? globalTranslations[language]["simplifiedChinese"]
                      : globalTranslations[language]["english"];
                  notification.textContent = globalTranslations[language][
                    "languageSetTo"
                  ].replace("%s", languageName);
                  notification.style.position = "fixed";
                  notification.style.top = "20px";
                  notification.style.left = "50%";
                  notification.style.transform = "translateX(-50%)";
                  notification.style.padding = "10px 20px";
                  notification.style.backgroundColor = "rgba(0,0,0,0.8)";
                  notification.style.color = "white";
                  notification.style.borderRadius = "5px";
                  notification.style.zIndex = "9999";
                  document.body.appendChild(notification);
                  setTimeout(() => notification.remove(), 2000);
                }
              });
            });
          </script>

          <!-- æ•°æ®ç®¡ç†å¡ç‰‡ -->
          <div class="settings-card">
            <div class="settings-card-header">
              <h3 data-i18n="dataManagement">æ•°æ®ç®¡ç†</h3>
            </div>
            <div class="settings-card-content">
              <p
                style="
                  margin-bottom: 20px;
                  color: var(--text-color);
                  line-height: 1.6;
                "
                data-i18n="dataManagementDescription"
              >
                é€šè¿‡å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ï¼Œæ‚¨å¯ä»¥å¤‡ä»½æ”¶è—æ•°æ®æˆ–ä¸å…¶ä»–æµè§ˆå™¨æ”¶è—å¤¹è¿›è¡ŒåŒæ­¥ã€‚
              </p>
              <div
                style="
                  display: flex;
                  gap: 15px;
                  margin-bottom: 15px;
                  flex-wrap: wrap;
                "
              >
                <button
                  id="importBtn"
                  style="
                    background-color: var(--primary-color);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    min-width: 120px;
                  "
                  data-i18n="importFavoritesBtn"
                >
                  å¯¼å…¥æ”¶è—å¤¹
                </button>
                <button
                  id="exportBtn"
                  style="
                    background-color: var(--accent-color);
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    transition: all 0.3s ease;
                    min-width: 120px;
                  "
                  data-i18n="exportFavoritesBtn"
                >
                  å¯¼å‡ºæ”¶è—å¤¹
                </button>
              </div>
            </div>
          </div>

          <!-- æ•°æ®ç®¡ç†è„šæœ¬ -->
          <script>
            // å¯¼å…¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById("importBtn").addEventListener("click", () => {
              ipcRenderer.send("import-favorites");
            });

            // å¯¼å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById("exportBtn").addEventListener("click", () => {
              ipcRenderer.send("export-favorites");
            });
          </script>

          <!-- éšç§æ”¿ç­–å¡ç‰‡ -->
          <div class="settings-card">
            <div class="settings-card-header">
              <h3 data-i18n="privacyPolicy">éšç§æ”¿ç­–</h3>
            </div>
            <div class="settings-card-content">
              <p
                style="
                  margin-bottom: 20px;
                  color: var(--text-color);
                  line-height: 1.6;
                "
                data-i18n="privacyPolicyDescription"
              >
                æŸ¥çœ‹æœ¬åº”ç”¨å¦‚ä½•ä¿æŠ¤æ‚¨çš„éšç§å’Œå¤„ç†æ‚¨çš„æ•°æ®ã€‚
              </p>
              <button
                id="privacyPolicyBtn"
                style="
                  background-color: var(--primary-color);
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: 500;
                  transition: all 0.3s ease;
                  min-width: 120px;
                "
                data-i18n="privacyPolicy"
              >
                æŸ¥çœ‹éšç§æ”¿ç­–
              </button>
            </div>
          </div>

          <!-- éšç§æ”¿ç­–è„šæœ¬ -->
          <script>
            // éšç§æ”¿ç­–æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById("privacyPolicyBtn").addEventListener(
              "click",
              () => {
                ipcRenderer.send("open-privacy-policy");
              }
            );
          </script>

          <!-- å¯¼å…¥å¯¼å‡ºåŠŸèƒ½é€šçŸ¥ç»„ä»¶ -->
          <div
            id="importExportNotification"
            style="
              display: none;
              position: fixed;
              top: 20px;
              left: 50%;
              transform: translateX(-50%);
              padding: 12px 24px;
              border-radius: 8px;
              z-index: 9999;
              color: white;
              font-weight: bold;
              background-color: var(--primary-color);
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
              animation: slideIn 0.3s ease-out;
            "
          ></div>

          <style>
            /* å¡ç‰‡æ ·å¼ */
            .settings-card {
              background-color: var(--card-color);
              border-radius: 12px;
              margin-bottom: 24px;
              overflow: hidden;
              box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
              border: 1px solid var(--border-color);
              transition: transform 0.3s ease, box-shadow 0.3s ease;
            }

            .settings-card:hover {
              transform: translateY(-2px);
              box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            }

            .settings-card-header {
              background: linear-gradient(
                135deg,
                rgba(var(--primary-rgb), 0.1) 0%,
                rgba(var(--primary-rgb), 0.05) 100%
              );
              padding: 16px 20px;
              border-bottom: 1px solid var(--border-color);
            }

            .settings-card-header h3 {
              margin: 0;
              color: var(--primary-color);
              font-size: 18px;
              font-weight: 600;
            }

            .settings-card-content {
              padding: 20px;
            }

            .settings-item {
              margin-bottom: 20px;
            }

            .settings-item:last-child {
              margin-bottom: 0;
            }

            .settings-label {
              display: block;
              margin-bottom: 8px;
              color: var(--text-color);
              font-weight: 500;
              font-size: 14px;
            }

            /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
            button:hover {
              filter: brightness(1.05);
            }

            button:active {
              transform: scale(0.98);
            }

            /* é€šçŸ¥åŠ¨ç”» */
            @keyframes slideIn {
              from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
              }
              to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
              }
            }
          </style>

          <!-- æ”¯æŒä¸æèµ  -->
          <div class="settings-item" style="margin-bottom: 2rem">
            <h3
              style="
                margin-bottom: 15px;
                color: var(--primary-color);
                font-size: 1.2rem;
                font-weight: 600;
              "
              data-i18n="supportAndDonation"
            >
              æ”¯æŒä¸æèµ 
            </h3>
            <div
              class="donation-section"
              style="
                background: linear-gradient(
                  135deg,
                  rgba(var(--primary-rgb), 0.05) 0%,
                  rgba(var(--primary-rgb), 0.1) 100%
                );
                border: 2px solid rgba(var(--primary-rgb), 0.2);
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.1);
              "
            >
              <p
                style="
                  margin-bottom: 15px;
                  font-size: 1rem;
                  line-height: 1.6;
                  color: var(--text-color);
                "
                data-i18n="donationDesc1"
              >
                æ”¶è—å¤¹è®°äº‹æœ¬æ˜¯ä¸€æ¬¾å®Œå…¨å…è´¹çš„å¼€æºè½¯ä»¶ï¼Œæˆ‘ä»¬è‡´åŠ›äºä¸ºç”¨æˆ·æä¾›æœ€å¥½çš„æ”¶è—ç®¡ç†ä½“éªŒã€‚
              </p>
              <p
                style="
                  margin-bottom: 20px;
                  font-size: 1rem;
                  line-height: 1.6;
                  color: var(--text-color);
                "
                data-i18n="donationDesc2"
              >
                <strong style="color: var(--primary-color)"
                  >å¦‚æœæ‚¨è§‰å¾—è¿™æ¬¾è½¯ä»¶å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œå¹¶ä¸”ç»æµæ¡ä»¶å…è®¸ï¼Œæ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¯æŒå¼€å‘è€…ï¼Œæ‚¨çš„æ¯ä¸€ä»½æ”¯æŒéƒ½æ˜¯æˆ‘ä»¬ç»§ç»­å¼€å‘å’Œæ”¹è¿›çš„åŠ¨åŠ›ï¼</strong
                >
              </p>

              <div
                style="
                  text-align: center;
                  margin: 30px 0;
                  background-color: var(--card-color);
                  padding: 20px;
                  border-radius: 8px;
                  border: 1px dashed var(--accent-color);
                "
              >
                <h4
                  style="
                    margin-top: 0;
                    margin-bottom: 15px;
                    color: var(--accent-color);
                    font-size: 1.1rem;
                  "
                  data-i18n="supportProject"
                >
                  ğŸ’– æ”¯æŒé¡¹ç›®å‘å±• ğŸ’–
                </h4>
                <p
                  style="margin-bottom: 20px; font-size: 1rem"
                  data-i18n="githubInfo"
                >
                  æ‚¨å¯ä»¥è®¿é—®æˆ‘ä»¬çš„ GitHub é¡¹ç›®ä¸»é¡µï¼Œäº†è§£æ›´å¤šæèµ æ–¹å¼å’Œé¡¹ç›®ä¿¡æ¯ï¼š
                </p>
                <button
                  id="githubBtn"
                  style="
                    padding: 12px 24px;
                    background-color: var(--accent-color);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 1rem;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    min-width: 180px;
                  "
                  data-i18n="visitGithubProject"
                >
                  è®¿é—® GitHub é¡¹ç›®
                </button>
              </div>

              <div
                style="
                  background-color: rgba(var(--primary-rgb), 0.1);
                  border-left: 4px solid var(--primary-color);
                  padding: 15px;
                  border-radius: 0 6px 6px 0;
                  margin-top: 20px;
                "
              >
                <p
                  style="margin-bottom: 10px; font-size: 0.95rem"
                  data-i18n="donationMethodsInfo"
                >
                  æˆ‘ä»¬çš„æ‰€æœ‰æèµ æ–¹å¼éƒ½å·²æ•´åˆåˆ° GitHub é¡¹ç›®é¡µé¢ä¸­ã€‚å¦‚æœæ‚¨æƒ³æ”¯æŒæˆ‘ä»¬çš„å¼€å‘å·¥ä½œï¼Œ
                  è¯·é€šè¿‡ä¸Šæ–¹æŒ‰é’®è®¿é—® GitHub é¡¹ç›®ä¸»é¡µï¼Œåœ¨é‚£é‡Œæ‚¨å¯ä»¥æ‰¾åˆ°åŒ…æ‹¬æ”¯ä»˜å®åœ¨å†…çš„å¤šç§æèµ æ–¹å¼ã€‚
                </p>
                <p
                  style="
                    text-align: center;
                    margin-top: 15px;
                    font-weight: 500;
                    color: var(--primary-color);
                  "
                  data-i18n="thankYouSupport"
                >
                  æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼Œæ‚¨çš„æ¯ä¸€ä»½é¼“åŠ±éƒ½æ˜¯æˆ‘ä»¬å‰è¿›çš„åŠ¨åŠ›ï¼
                </p>
              </div>
            </div>
          </div>
          <script>
            // GitHubæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById("githubBtn").addEventListener("click", () => {
              // ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æµè§ˆå™¨æ‰“å¼€GitHubé¡¹ç›®é¡µé¢
              ipcRenderer.send(
                "open-external-browser",
                "https://github.com/samson7s/favorites-browser"
              );
            });
          </script>
          <div class="settings-item">
            <button id="aboutBtn" class="save-btn" data-i18n="aboutDeveloper">
              å…³äºå¼€å‘è€…
            </button>
            <script>
              document.getElementById("aboutBtn").addEventListener("click", () => {
                ipcRenderer.send("open-about-window");
              });
            </script>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      // è®¾ç½®è§†å›¾æ§åˆ¶
      const settingsBtn = document.getElementById("settingsBtn");
      const backBtn = document.getElementById("backBtn");
      const settingsView = document.getElementById("settingsView");
      const mainContent = document.querySelector(".main-content");
      const header = document.querySelector(".header");

      settingsBtn.addEventListener("click", () => {
        settingsView.style.display = "block";
        header.style.display = "none";
        mainContent.style.display = "none";
      });

      backBtn.addEventListener("click", () => {
        settingsView.style.display = "none";
        header.style.display = "flex";
        mainContent.style.display = "block";
      });

      // æ·»åŠ æ”¶è—ï¼ˆé€šè¿‡IPCå‘é€åˆ°ä¸»è¿›ç¨‹ï¼‰
      function addFavorite(title, url) {
        const finalTitle = title ? title : url;
        ipcRenderer.send("add-favorite", { title: finalTitle, url });
      }

      // åˆ é™¤æ”¶è—é¡¹ï¼ˆé€šè¿‡IPCå‘é€åˆ°ä¸»è¿›ç¨‹ï¼‰
      // åˆ›å»ºæ“ä½œèœå•æ§ä»¶çš„å·¥å‚å‡½æ•°
      function createActionMenu(items) {
        // åˆ›å»ºä¸»å®¹å™¨
        const container = document.createElement("div");
        container.className = "ActionMenu";

        // åˆ›å»ºæŒ‰é’®
        const button = document.createElement("button");
        button.className = "btn ActionMenu-button";
        button.style.marginLeft = "8px";
        button.style.height = "32px";
        button.style.fontSize = "14px";
        button.innerHTML =
          globalTranslations[getCurrentLanguage()]["action"] +
          ' <span class="ActionMenu-caret"></span>';
        container.appendChild(button);

        // åˆ›å»ºä¸‹æ‹‰èœå•
        const dropdown = document.createElement("div");
        dropdown.className = "ActionMenu-dropdown";
        dropdown.style.display = "none";
        document.body.appendChild(dropdown);

        // æ·»åŠ èœå•é¡¹
        items.forEach((item, index) => {
          // æ·»åŠ åˆ†éš”çº¿ï¼ˆéç¬¬ä¸€é¡¹å‰ï¼‰
          if (index > 0) {
            const separator = document.createElement("div");
            separator.className = "ActionMenu-separator";
            dropdown.appendChild(separator);
          }

          const menuItem = document.createElement("button");
          menuItem.className = "ActionMenu-item";
          menuItem.textContent = item.label;
          menuItem.addEventListener("click", () => {
            item.onClick();
            toggleMenu(false); // ç‚¹å‡»åå…³é—­èœå•
          });
          dropdown.appendChild(menuItem);
        });

        // åˆ‡æ¢èœå•æ˜¾ç¤ºçŠ¶æ€
        function toggleMenu(show) {
          const wasOpen = dropdown.style.display === "block";
          const shouldOpen = show !== undefined ? show : !wasOpen;

          if (shouldOpen) {
            // å…³é—­æ‰€æœ‰å…¶ä»–æ‰“å¼€çš„èœå•
            document.querySelectorAll(".ActionMenu-dropdown").forEach((menu) => {
              if (menu !== dropdown) {
                menu.style.display = "none";
              }
            });
            dropdown.style.display = "block";
            const rect = button.getBoundingClientRect();
            const menuWidth = dropdown.offsetWidth || 200;
            const viewportWidth = window.innerWidth;
            const rightSpace = viewportWidth - rect.right;

            if (rightSpace < menuWidth) {
              dropdown.style.right = `${viewportWidth - rect.right}px`;
              dropdown.style.left = "auto";
            } else {
              dropdown.style.left = `${rect.left}px`;
              dropdown.style.right = "auto";
            }
            dropdown.style.top = `${rect.bottom}px`;

            const scrollContainer =
              document.querySelector(".downloading") || window;
            if (scrollContainer) {
              const handleScroll = () => {
                const newRect = button.getBoundingClientRect();
                const menuWidth =
                  dropdown.getBoundingClientRect().width || 200;
                const viewportWidth = window.innerWidth;
                const rightSpace = viewportWidth - newRect.right - 10;

                if (rightSpace < menuWidth) {
                  dropdown.style.right = `${viewportWidth - newRect.right}px`;
                  dropdown.style.left = "auto";
                } else {
                  dropdown.style.left = `${newRect.left}px`;
                  dropdown.style.right = "auto";
                }
                dropdown.style.top = `${newRect.bottom}px`;
              };
              scrollContainer.addEventListener("scroll", handleScroll);
              dropdown.handleScroll = handleScroll;
              dropdown.scrollContainer = scrollContainer;
            }
          } else {
            if (dropdown.scrollContainer && dropdown.handleScroll) {
              dropdown.scrollContainer.removeEventListener(
                "scroll",
                dropdown.handleScroll
              );
            }
            dropdown.style.display = "none";
            dropdown.dataset.open = "false";
          }
          container.classList.toggle("open", shouldOpen);
        }

        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        button.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleMenu();
        });

        // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­èœå•
        const closeOnOutsideClick = (e) => {
          if (!container.contains(e.target)) {
            toggleMenu(false);
          }
        };

        document.addEventListener("click", closeOnOutsideClick);

        // æ¸…ç†å‡½æ•°ï¼ˆå¯é€‰ï¼Œç”¨äºç»„ä»¶é”€æ¯æ—¶ï¼‰
        container.destroy = () => {
          document.removeEventListener("click", closeOnOutsideClick);
        };

        return container;
      }

      function closeAllActionMenus() {
        document.querySelectorAll(".ActionMenu-dropdown").forEach((menu) => {
          menu.style.display = "none";
        });
      }

      function deleteFavorite(index) {
        if (
          !confirm(
            globalTranslations[getCurrentLanguage()]["confirmDeleteFavorite"]
          )
        )
          return;
        ipcRenderer.send("delete-favorite", index);
      }

      window.showEditDialog = function (index) {
        ipcRenderer
          .invoke("show-edit-dialog", index)
          .then((result) => {
            if (result) {
              loadFavorites();
            }
          })
          .catch((err) => {
            console.error("Error showing edit dialog:", err);
          });
      };

      window.editEpisodes = function (index) {
        if (!window.favorites || !Array.isArray(window.favorites)) {
          alert(
            globalTranslations[getCurrentLanguage()]["favoriteDataNotLoaded"]
          );
          return;
        }
        const item = window.favorites[index];
        if (!item) {
          alert(
            globalTranslations[getCurrentLanguage()]["cannotFindFavoriteItem"]
          );
          return;
        }

        ipcRenderer
          .invoke("show-episode-dialog", index)
          .then((result) => {
            if (!result || !result.success) return;
            const { total = 0, downloaded = 0 } = result;
            const totalNum =
              typeof total === "number" && !isNaN(total) ? total : 0;
            const downloadedNum =
              typeof downloaded === "number" && !isNaN(downloaded)
                ? downloaded
                : 0;
            if (downloadedNum > totalNum) {
              alert(
                globalTranslations[getCurrentLanguage()][
                  "downloadedEpisodesCannotExceedTotal"
                ]
              );
              return;
            }
            item.totalEpisodes = totalNum;
            item.downloadedEpisodes = downloadedNum;
            ipcRenderer.send("update-favorites", window.favorites);
            renderFavorites();
          })
          .catch((err) => {
            console.error("Error editing episodes:", err);
            alert(
              globalTranslations[getCurrentLanguage()]["editEpisodesError"]
            );
          });
      };

      let draggedIndex = null;

      // æ¸²æŸ“æ”¶è—åˆ—è¡¨ï¼ˆæ¥æ”¶ä¸»è¿›ç¨‹æ•°æ®ï¼‰
      function renderFavorites(favorites) {
        document.querySelectorAll(".ActionMenu").forEach((menu) => {
          menu.destroy?.();
          menu.remove();
        });
        document.querySelectorAll(".ActionMenu-dropdown").forEach((dropdown) => {
          dropdown.remove();
        });

        const isInitialRender = !window.hasRenderedFavorites;
        window.hasRenderedFavorites = true;

        if (isInitialRender) {
          favorites.forEach((item) => {
            item.isNew = false;
          });
        }

        // å¯¹æ”¶è—é¡¹è¿›è¡Œæ’åºï¼Œä½¿ç½®é¡¶é¡¹æ˜¾ç¤ºåœ¨æœ€å‰é¢
        const sortedFavorites = [...favorites].sort((a, b) => {
          // ç½®é¡¶é¡¹æ’åœ¨å‰é¢
          if (a.pinToTop && !b.pinToTop) return -1;
          if (!a.pinToTop && b.pinToTop) return 1;
          return 0;
        });

        window.favorites = favorites;
        const downloadingList = document.getElementById("downloadingList");
        const downloadedList = document.getElementById("downloadedList");

        downloadingList.innerHTML = "";
        downloadedList.innerHTML = "";

        const hasNewItems = favorites.some((item) => item.isNew);

        if (favorites.length === 0) {
          downloadingList.innerHTML = `<div class="empty-tip">${
            globalTranslations[getCurrentLanguage()]["dataEmptyAddFavorite"]
          }</div>`;
          downloadedList.innerHTML = `<div class="empty-tip">${
            globalTranslations[getCurrentLanguage()]["noDownloadedItems"]
          }</div>`;
          return;
        } else {
          const newItemIndex = favorites.findIndex((item) => item.isNew);
          sortedFavorites.forEach((item, sortedIndex) => {
            // æ‰¾åˆ°åŸå§‹ç´¢å¼•ï¼Œç”¨äºæ“ä½œèœå•
            const originalIndex = favorites.findIndex(
              (fav) => fav.title === item.title && fav.url === item.url
            );
            const isNewItem = item.isNew && item.isNew === true;
            const { title, url } = item;
            const itemElement = document.createElement("div");
            itemElement.className = "favorite-item";
            // å¦‚æœæ˜¯ç½®é¡¶é¡¹ï¼Œæ·»åŠ ç½®é¡¶æ ‡è®°
            if (item.pinToTop) {
              itemElement.classList.add("pinned-item");
            }
            itemElement.draggable = true;
            itemElement.dataset.index = originalIndex;

            const titleSpan = document.createElement("span");
            titleSpan.style.flex = "1";
            titleSpan.style.wordBreak = "break-all";

            // æ£€æŸ¥URLæ˜¯å¦å±äºä¼˜é…·è§†é¢‘
            let isYoukuVideo = false;
            let isBilibiliVideo = false;
            let isBaiduDisk = false;
            let isAliyunDrive = false;

            try {
              const itemUrl = new URL(item.url);
              const domain = itemUrl.hostname;
              isYoukuVideo = domain.includes("youku.com");
              isBilibiliVideo = domain.includes("bilibili.com");
              isBaiduDisk =
                domain.includes("baidudisk.com") || domain.includes("pan.baidu.com");
              isAliyunDrive =
                domain.includes("aliyundrive.com") || domain.includes("alipan.com");
            } catch (e) {
              // æ— æ•ˆURLï¼Œé»˜è®¤ä¸ºéè§†é¢‘å¹³å°
            }

            // ä¸ºç½®é¡¶é¡¹å’Œä¼˜é…·è§†é¢‘æ·»åŠ æ ‡è®°
            let displayTitle = title;

            // æ¸…ç©ºæ ‡é¢˜å®¹å™¨ï¼Œå‡†å¤‡é‡æ–°æ„å»º
            titleSpan.textContent = "";

            // 1. å…ˆæ·»åŠ ç½®é¡¶æ ‡è®°ï¼ˆæœ€å·¦ä¾§ï¼‰
            if (item.pinToTop) {
              const pinIcon = document.createTextNode("ğŸ“Œ ");
              titleSpan.appendChild(pinIcon);
            }

            // 2. ç„¶åæ·»åŠ ä¼˜é…·å›¾æ ‡
            if (isYoukuVideo) {
              const youkuIcon = document.createElement("img");
              youkuIcon.src = "./assets/images/youku-100.png";
              youkuIcon.style.width = "20px";
              youkuIcon.style.height = "20px";
              youkuIcon.style.marginRight = "5px";
              youkuIcon.style.verticalAlign = "middle";
              titleSpan.appendChild(youkuIcon);
            }

            // æ·»åŠ Bç«™å›¾æ ‡
            if (isBilibiliVideo) {
              const bilibiliIcon = document.createElement("img");
              bilibiliIcon.src = "./assets/images/bilibili-100.png";
              bilibiliIcon.style.width = "20px";
              bilibiliIcon.style.height = "20px";
              bilibiliIcon.style.marginRight = "5px";
              bilibiliIcon.style.verticalAlign = "middle";
              titleSpan.appendChild(bilibiliIcon);
            }

            // æ·»åŠ ç™¾åº¦ç½‘ç›˜å›¾æ ‡
            if (isBaiduDisk) {
              const baiduDiskIcon = document.createElement("img");
              baiduDiskIcon.src = "./assets/images/baidudisk-100.png";
              baiduDiskIcon.style.width = "20px";
              baiduDiskIcon.style.height = "20px";
              baiduDiskIcon.style.marginRight = "5px";
              baiduDiskIcon.style.verticalAlign = "middle";
              titleSpan.appendChild(baiduDiskIcon);
            }

            // æ·»åŠ é˜¿é‡Œäº‘ç½‘ç›˜å›¾æ ‡
            if (isAliyunDrive) {
              const aliyunDriveIcon = document.createElement("img");
              aliyunDriveIcon.src = "./assets/images/aliyundrive-100.png";
              aliyunDriveIcon.style.width = "20px";
              aliyunDriveIcon.style.height = "20px";
              aliyunDriveIcon.style.marginRight = "5px";
              aliyunDriveIcon.style.verticalAlign = "middle";
              titleSpan.appendChild(aliyunDriveIcon);
            }

            // 3. æœ€åæ·»åŠ æ ‡é¢˜æ–‡æœ¬
            const titleText = document.createTextNode(displayTitle);
            titleSpan.appendChild(titleText);

            itemElement.appendChild(titleSpan);

            const episodeBtn = document.createElement("button");
            episodeBtn.className = "btn episode-btn";
            episodeBtn.style.height = "32px";
            episodeBtn.style.fontSize = "14px";

            // æ£€æŸ¥URLæ˜¯å¦å±äºè§†é¢‘å¹³å°
            // åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ç›´æ¥å®ç°æ£€æŸ¥é€»è¾‘ï¼Œé¿å…æ¨¡å—å¯¼å…¥é—®é¢˜
            let isVideoPlatform = false;
            try {
              // çŸ¥åè§†é¢‘å¹³å°åŸŸååˆ—è¡¨
              const videoPlatforms = [
                "v.qq.com", // è…¾è®¯è§†é¢‘
                "www.bilibili.com", // Bilibili
                "www.iqiyi.com", // çˆ±å¥‡è‰º
                "youku.com", // ä¼˜é…·
                "mgtv.com", // èŠ’æœTV
                "sohu.com", // æœç‹è§†é¢‘
                "le.com", // ä¹è§†è§†é¢‘
              ];

              const url = new URL(item.url);
              const domain = url.hostname;
              isVideoPlatform = videoPlatforms.some((platform) =>
                domain.includes(platform)
              );
            } catch (e) {
              // æ— æ•ˆURLï¼Œé»˜è®¤ä¸ºéè§†é¢‘å¹³å°
            }

            // æ ¹æ®æ˜¯å¦ä¸ºè§†é¢‘å¹³å°é€‰æ‹©æ˜¾ç¤ºæ–‡æœ¬
            const dlLabelShort = isVideoPlatform
              ? globalTranslations[getCurrentLanguage()]["watchedLabelShort"] ||
                "è§‚çœ‹:"
              : globalTranslations[getCurrentLanguage()]["downloadedLabelShort"] ||
                "ä¸‹è½½:";
            const fullyDLText = isVideoPlatform
              ? globalTranslations[getCurrentLanguage()]["fullyWatched"] || "å·²è§‚çœ‹"
              : globalTranslations[getCurrentLanguage()]["fullyDownloaded"] || "å·²ä¸‹è½½";
            const dlEpisodesShort = isVideoPlatform
              ? globalTranslations[getCurrentLanguage()]["watchedLabelShort"] ||
                "è§‚çœ‹:"
              : globalTranslations[getCurrentLanguage()][
                  "downloadedEpisodesShort"
                ] || "å·²ä¸‹è½½:";

            episodeBtn.textContent =
              (item.totalEpisodes || 0) === 0
                ? (item.downloadedEpisodes || 0) === 0
                  ? globalTranslations[getCurrentLanguage()]["setEpisodes"]
                  : `${dlLabelShort}${item.downloadedEpisodes || 0}`
                : (item.totalEpisodes || 0) === (item.downloadedEpisodes || 0)
                ? fullyDLText
                : `${
                    globalTranslations[getCurrentLanguage()]["totalEpisodesShort"]
                  }${item.totalEpisodes || 0} / ${dlEpisodesShort}${
                    item.downloadedEpisodes || 0
                  }`;
            episodeBtn.addEventListener("click", async function () {
              const itemIndex = parseInt(
                this.closest(".favorite-item").dataset.index
              );
              await ipcRenderer.invoke("show-episode-dialog", itemIndex);
            });
            itemElement.appendChild(episodeBtn);

            const actionDiv = document.createElement("div");
            actionDiv.className = "action-buttons";

            const visitBtn = document.createElement("button");
            visitBtn.className = "btn visit-btn";
            visitBtn.style.height = "32px";
            visitBtn.style.fontSize = "14px";
            visitBtn.textContent =
              globalTranslations[getCurrentLanguage()]["visit"];
            visitBtn.addEventListener("click", () => {
              // æ£€æŸ¥æ˜¯å¦æœ‰openMethodå±æ€§ï¼Œå¹¶æ ¹æ®å±æ€§å€¼å†³å®šæ‰“å¼€æ–¹å¼
              if (item.openMethod && item.openMethod === "external") {
                // ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æµè§ˆå™¨æ‰“å¼€
                ipcRenderer.send("open-external-browser", url);
              } else {
                // ä½¿ç”¨å†…éƒ¨çª—å£æ‰“å¼€ï¼ŒåŒæ—¶ä¼ é€’originalIndex
                ipcRenderer.send("open-new-window", url, originalIndex);
              }
            });
            actionDiv.appendChild(visitBtn);

            const menu = createActionMenu([
              {
                label: globalTranslations[getCurrentLanguage()]["edit"],
                onClick: () => {
                  showEditDialog(originalIndex);
                },
              },
              {
                label: globalTranslations[getCurrentLanguage()]["delete"],
                onClick: () => deleteFavorite(originalIndex),
              },
            ]);
            actionDiv.appendChild(menu);

            itemElement.appendChild(actionDiv);

            if (isNewItem && !isInitialRender) {
              itemElement.classList.add("new-item");
              setTimeout(() => {
                item.isNew = false;
              }, 1000);
              requestAnimationFrame(() => {
                const container = document.body;
                container.scrollTo({
                  top: container.scrollHeight,
                  behavior: "smooth",
                });
              });
            }

            itemElement.addEventListener("dragstart", (e) => {
              draggedIndex = e.target.dataset.index;
              e.dataTransfer.effectAllowed = "move";
              e.target.classList.add("dragging");
            });

            itemElement.addEventListener("dragend", (e) => {
              e.target.classList.remove("dragging");
            });

            itemElement.addEventListener("dragover", (e) => {
              e.preventDefault();
              e.dataTransfer.dropEffect = "move";
            });

            itemElement.addEventListener("drop", (e) => {
              e.preventDefault();
              const targetIndex = parseInt(
                e.target.closest(".favorite-item").dataset.index
              );
              const fromIndex = parseInt(draggedIndex);

              if (fromIndex !== targetIndex) {
                // ç§»é™¤è¢«æ‹–åŠ¨çš„é¡¹ç›®
                const draggedItem = favorites.splice(fromIndex, 1)[0];
                // åœ¨ç›®æ ‡ä½ç½®æ’å…¥è¢«æ‹–åŠ¨çš„é¡¹ç›®
                favorites.splice(targetIndex, 0, draggedItem);

                ipcRenderer.send("update-favorites-order", favorites);
                renderFavorites(favorites);
              }
            });

            const total = item.totalEpisodes || 0;
            const downloaded = item.downloadedEpisodes || 0;

            if (total > 0 && total === downloaded) {
              downloadedList.appendChild(itemElement);
            } else {
              downloadingList.appendChild(itemElement);
            }
          });

          if (downloadingList.children.length === 0) {
            downloadingList.innerHTML = `<div class="empty-tip">${
              globalTranslations[getCurrentLanguage()]["noDownloadingItems"]
            }</div>`;
          }
          if (downloadedList.children.length === 0) {
            downloadedList.innerHTML = `<div class="empty-tip">${
              globalTranslations[getCurrentLanguage()]["noDownloadedItems"]
            }</div>`;
          }

          document.querySelectorAll(".tab-btn").forEach((btn) =>
            btn.classList.remove("active")
          );
          document
            .querySelector('.tab-btn[data-tab="downloading"]')
            .classList.add("active");
        }
      }

      // åˆå§‹åŒ–ï¼šè¯·æ±‚åŠ è½½æ”¶è—
      ipcRenderer.send("get-favorites");
      // æ¥æ”¶æ”¶è—æ›´æ–°äº‹ä»¶
      ipcRenderer.on("favorites-updated", (event, favorites) => {
        renderFavorites(favorites);
        // åŒæ—¶æ›´æ–°æ ‡ç­¾é¡µè®¡æ•°
        updateTabCounts();
      });

      // æ ‡ç­¾åˆ‡æ¢é€»è¾‘
      document.querySelectorAll(".tab-btn").forEach((button) => {
        button.addEventListener("click", () => {
          document.querySelectorAll(".tab-btn").forEach((btn) =>
            btn.classList.remove("active")
          );
          button.classList.add("active");

          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.remove("active");
          });

          const tabId = button.dataset.tab;
          document.getElementById(`${tabId}List`).classList.add("active");
        });
      });

      // æœç´¢åŠŸèƒ½å®ç°
      const searchInput = document.getElementById("searchInput");

      function updateTabCounts() {
        const searchTerm = searchInput.value.toLowerCase();
        const allItems = document.querySelectorAll(".favorite-item");
        let downloadingCount = 0,
          downloadedCount = 0;

        allItems.forEach((item) => {
          const isVisible = item.style.display !== "none";
          if (!isVisible) return;

          // æ£€æŸ¥é¡¹ç›®æ˜¯å¦å±äºå·²ä¸‹è½½ç±»åˆ«
          const titleSpan = item.querySelector("span");
          const itemIndex = parseInt(item.dataset.index);
          const itemData = window.favorites && window.favorites[itemIndex];
          const isDownloaded =
            itemData &&
            itemData.totalEpisodes &&
            itemData.totalEpisodes === itemData.downloadedEpisodes;

          if (isDownloaded) downloadedCount++;
          else downloadingCount++;
        });

        // æ›´æ–°æ ‡ç­¾é¡µè®¡æ•°
        document.querySelector(
          '[data-tab="downloading"] .tab-count'
        ).textContent = `(${downloadingCount})`;
        document.querySelector(
          '[data-tab="downloaded"] .tab-count'
        ).textContent = `(${downloadedCount})`;
      }

      function filterFavorites() {
        const searchTerm = searchInput.value.toLowerCase();
        const favorites = document.querySelectorAll(".favorite-item");
        const hasSearchTerm = !!searchTerm;

        // æ˜¾ç¤º/éšè—æ¸…ç©ºæŒ‰é’®
        document.getElementById("clearSearch").style.display = hasSearchTerm
          ? "block"
          : "none";

        favorites.forEach((favorite) => {
          const title = favorite
            .querySelector("span")
            .textContent.toLowerCase();
          const shouldShow = !hasSearchTerm || title.includes(searchTerm);
          favorite.style.display = shouldShow ? "flex" : "none";
        });

        // æ›´æ–°æ ‡ç­¾é¡µè®¡æ•°
        updateTabCounts();
      }

      // ä¸ºæœç´¢æ¡†æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬
      // æœç´¢æ¡†äº‹ä»¶ç›‘å¬
      searchInput.addEventListener("input", filterFavorites);

      // æ¸…ç©ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById("clearSearch").addEventListener("click", () => {
        searchInput.value = "";
        filterFavorites();
      });

      // åˆå§‹åŠ è½½æ—¶æ›´æ–°è®¡æ•°
      document.addEventListener("DOMContentLoaded", updateTabCounts);

      // æ–°æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById("addBtn").addEventListener("click", () => {
        ipcRenderer.send("open-add-dialog");
      });

      // å¤„ç†å¯¼å…¥å¯¼å‡ºé€šçŸ¥
      ipcRenderer.on("import-export-notification", (event, data) => {
        const notification = document.getElementById(
          "importExportNotification"
        );

        // è®¾ç½®é€šçŸ¥æ ·å¼å’Œå†…å®¹
        notification.style.display = "block";
        notification.style.backgroundColor =
          data.type === "success" ? "#4caf50" : "#f44336";
        notification.textContent = data.message;

        // 3ç§’åè‡ªåŠ¨éšè—é€šçŸ¥
        setTimeout(() => {
          notification.style.display = "none";
        }, 3000);
      });
    </script>
  </body>
</html>